name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # === Web (Next.js) ===
  web:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/web
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: apps/web/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Lint
        run: npm run lint
      
      - name: Build
        run: npm run build
      
      - name: Test
        run: npm run test --if-present

  # === Engine (FastAPI) ===
  engine:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/engine
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: services/engine/requirements.txt
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install ruff pytest pytest-asyncio
      
      - name: Lint (Ruff)
        run: ruff check .
      
      - name: Test (Pytest)
        run: pytest -v --ignore=tests/integration

  # === Worker (Arq) ===
  worker:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/worker
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: services/worker/requirements.txt
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install ruff pytest pytest-asyncio
      
      - name: Lint (Ruff)
        run: ruff check .
      
      - name: Test (Pytest)
        run: pytest -v --ignore=tests/integration

  # === Migration Check ===
  migration:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check migration files exist
        run: |
          if [ ! -d "infra/supabase/migrations" ]; then
            echo "Error: migrations directory not found"
            exit 1
          fi
          echo "âœ… Migrations directory exists"
          ls -la infra/supabase/migrations/

  # === Golden Set Scoring Regression Tests ===
  golden-set:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install pytest pyyaml
      
      - name: Run Golden Set Tests
        run: |
          echo "ðŸ§ª Running Scoring Regression Tests..."
          python tests/golden_set/test_scoring_regression.py
          pytest tests/golden_set/ -v --tb=short

  # === E2E Tests (Playwright) ===
  e2e-tests:
    runs-on: ubuntu-latest
    needs: [web]  # web build must pass first
    defaults:
      run:
        working-directory: apps/web
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: apps/web/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Playwright Browsers
        run: npx playwright install --with-deps chromium
      
      - name: Run Playwright tests
        run: npx playwright test --reporter=html
        continue-on-error: true  # Don't fail CI on E2E failures (optional)
      
      - name: Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: apps/web/playwright-report/
          retention-days: 30
