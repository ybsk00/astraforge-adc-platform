# ADC 도메인 자동화 + RDKit 계산(응집성/독성/바이스텐딩) + 다중항체 적용성 평가 설계서

## 0. 목표
Seed Set(암종/표적/약물/페이로드/항체/링커)을 기반으로,
- 외부 소스(OpenTargets/UniProt/PubMed/ChEMBL/PubChem/ClinicalTrials/HPA/openFDA)에서 자동 수집
- 표준화(Canonical ID) 및 근거(Evidence) 축적
- RDKit 계산으로 구조 기반 리스크/가능성 점수 산출
- 결과를 “설계 의사결정 가능한 리포트”로 제공

추가 기능(이번 요청):
1) 응집성(aggregation risk) 점수화
2) 독성(toxicity risk) 경고/점수화
3) 바이스텐딩(bystander proxy) 점수화
4) 다중항체(바이/멀티스페시픽) 적용 가능성 평가

---

## 1. 핵심 원칙 (실제 구현을 위한 현실적 가이드)
- RDKit는 “예측 엔진”이 아니라 **구조 → 수치화(Descriptor/Fingerprint)** 엔진이다.
- 따라서 MVP에서는:
  - (A) 규칙 기반 스코어(대리지표) + (B) 구조 경고(알럿) + (C) 근거 링크(RAG)
  형태로 제공한다.
- 고도화 단계에서:
  - 공개 데이터/내부 축적 데이터로 QSAR/ML 모델을 붙여 “확률 예측”을 추가한다.
- “바이스텐딩 효과”와 “다중항체 적용 가능성”은 다변수 시스템 문제이므로,
  **Proxy Score(대리지표) + 룰/근거 기반**으로 시작하고 레이블 축적 후 모델화한다.

---

## 2. 데이터 모델 (Supabase 기준: 핵심 테이블)
### 2.1 Seed 및 엔티티
- seeds
  - id, type(cancer/target/drug/payload/antibody/linker), name, canonical_id, canonical_source, synonyms[], tags[], status
- entities_targets
  - id, uniprot_id, gene_symbol, name, function_summary, domains[], subcellular_location, notes
- entities_payloads
  - id, name, smiles, inchikey, pubchem_cid, chembl_id, class, notes
- entities_antibodies
  - id, name, format(IgG1/IgG4/bsAb...), is_internalizing(bool), epitope_notes, notes
- entities_linkers
  - id, name, type(cleavable/noncleavable), mechanism, notes

### 2.2 Ingestion/Run/Job
- runs
  - id, run_type(ingestion/design/full), objective, seed_scope(json), sources[], status, created_by, created_at
- jobs
  - id, run_id, step(query/fetch/normalize/evidence/index/calc/report), connector, status, attempts, error, started_at, finished_at

### 2.3 근거(Evidence)
- evidences
  - id, run_id, entity_type(target/payload/...), entity_id, source(PubMed/OpenTargets/...), evidence_type(abstract/snippet/db_record),
    excerpt, url, score, created_at

### 2.4 계산(Computations) 결과
- computations_payload_rdkit
  - id, run_id, payload_id,
    mw, clogp, tpsa, hbd, hba, rotb, rings, arom_rings, fsp3,
    aggregation_score, bystander_proxy_score,
    toxicity_alerts(json), pains_alerts(json),
    computed_at
- computations_target_multispecific
  - id, run_id, target_a_id, target_b_id,
    expression_selectivity_score, coexpression_risk_score,
    internalization_score, safety_overlap_score,
    bsab_applicability_score,
    rationale(json), computed_at

> 주의: “독성 예측 확률”은 MVP에서 제외(룰/알럿 중심). 고도화 시 computations_payload_toxicity_model 테이블 추가.

---

## 3. 파이프라인 설계 (Seed-driven + 계산 단계 추가)

### 3.1 Run 타입 정의
- Ingestion Run: 외부 소스에서 도메인 데이터 수집/정규화/근거화
- Calc Run: RDKit 계산 및 스코어 산출 (Ingestion 결과를 입력으로 사용)
- Full Pipeline: Ingestion + Calc + Report

### 3.2 단계(스텝) 구성
1) Query Build
2) Fetch (Connector별)
3) Normalize (Canonical ID 매핑)
4) Evidence (문헌/DB 근거 추출)
5) Calc (신규) ✅
   - Payload RDKit 계산
   - Rule-based scores (aggregation/bystander)
   - Structural alerts (toxicity/pains/reactive)
   - Multi-specific applicability scoring
6) Report (신규 강화) ✅
   - “추천 조합” 및 “리스크/근거” 포함

---

## 4. RDKit 계산 설계(실제 적용 가능한 수준)

## 4.1 Payload 입력 요건
- payload.smiles 가 필수 (없으면 PubChem/ChEMBL에서 보강)
- 실패 처리:
  - SMILES 없음 → Calc 단계에서 “skipped_missing_smiles”
  - 파싱 실패 → “invalid_smiles” 에러 + 운영자가 수정 가능

## 4.2 RDKit 기본 Descriptor (공통 산출)
- MW, cLogP(Crippen), TPSA
- HBD/HBA
- Rotatable Bonds
- Ring count / Aromatic ring count
- FractionCSP3

이를 computations_payload_rdkit에 저장

---

## 5. 스코어 정의(응집성/독성/바이스텐딩) — MVP 규칙 기반

## 5.1 응집성 Aggregation Risk Score (0~100)
### 목적
“실험에서 aggregation 문제를 일으킬 가능성”을 물성 기반으로 사전 경고

### 입력( RDKit descriptor )
- clogp, tpsa, arom_rings, rings, rotb, fsp3, mw

### 예시 규칙(초기값; 운영자가 조정 가능)
- 기본 점수 = 0
- +20 if clogp > 3.5
- +15 if tpsa < 40
- +10 if arom_rings >= 3
- +10 if rings >= 4
- +10 if rotb > 8 (유연성↑ → 비특이 결합/응집 경향 가중)
- +10 if mw > 700
- -10 if fsp3 > 0.35 (3D 성향이 높으면 응집 리스크 완화)

Clamp: 0~100

### 출력
- aggregation_score
- 트리거된 규칙 목록(rationale) → evidences와 별도로 “calc rationale”로 UI 표시

> 고도화: known aggregator/PAINS 데이터셋으로 분류 모델 추가 가능

---

## 5.2 독성 Toxicity Risk (MVP: Alerts 기반)
### 목적
독성 “예측 확률”이 아니라, 구조적 위험 모티프를 탐지해 경고

### 구성
A) Reactive/Electrophilic motif alerts (SMARTS rule set)
- Michael acceptor, alkylating, epoxide, aniline 등

B) PAINS/Brenk alerts
- PAINS 패턴 매칭 결과를 pains_alerts[]로 기록

### 출력
- toxicity_alerts: [{rule_id, name, severity, matched_smarts}]
- pains_alerts: [{rule_id, name}]

> 고도화: Tox21/ToxCast 기반 모델 확률(tox_score)을 별도 컬럼으로 추가

---

## 5.3 바이스텐딩 Bystander Proxy Score (0~100)
### 목적
“방출된 payload가 주변 세포로 확산할 가능성”을 물성 기반으로 점수화

### 입력
- clogp, tpsa, mw, hbd, charge(가능하면 RDKit로 formal charge)

### 예시 산식(초기값)
- 기본 점수 50에서 시작
- +15 if clogp between 2.0 and 4.5 (막투과성 유리)
- +10 if tpsa < 70
- -15 if tpsa > 120
- -10 if hbd >= 3 (극성↑ 확산↓)
- -10 if mw > 900
- -15 if formal_charge != 0 (이온성은 확산/막투과에 불리)

Clamp: 0~100

### 보정(링커 연동; 선택)
- linker.type == cleavable 이면 +10
- noncleavable 이면 -10
> 이 보정은 computations_linker_score 또는 report 단계에서 합성 스코어로 반영 가능

---

## 6. 다중항체(바이/멀티스페시픽) 적용 가능성 평가 — 실제 운영 가능한 룰/근거 기반

## 6.1 평가 목적
어떤 Target A + Target B 조합이 bsAb/멀티스페시픽 설계에 “합리적인가”를,
- 발현 선택성(암 vs 정상)
- 공발현/교차 독성 리스크
- 내부화(internalization) 가능성
- 안전성(조직 발현 중첩) 및 근거 수준
기준으로 점수화

## 6.2 입력 데이터 소스 매핑
- Open Targets: 질환-표적 연관성(우선순위)
- HPA: 조직별 발현(Selectivity & Safety overlap)
- UniProt: 막단백/수용체 여부, subcellular location(표적 적합성)
- PubMed: 내부화/항체 접근성/바이오마커 근거(텍스트 근거)
- ClinicalTrials/openFDA: 안전성/부작용 간접 근거(선택)

## 6.3 스코어 구성(0~100)
1) Expression Selectivity Score (0~25)
   - 종양 관련 근거 + 정상 조직 발현 낮음
2) Co-expression Risk Score (0~25, 역점수)
   - 정상 조직에서 A/B 동시 발현 가능성↑이면 감점
3) Internalization Score (0~25)
   - 내부화 표적(수용체/내재화 근거) 가점
4) Safety Overlap Score (0~25, 역점수)
   - 심장/간/신장/뇌 등 필수 장기 고발현이면 감점

최종:
- bsab_applicability_score = selectivity + internalization - coexpression_penalty - safety_penalty
Clamp 0~100

### 출력(rationale json)
- 어떤 조직에서 위험이 큰지(HPA 기반)
- UniProt 상 위치(막/분비/핵 등)
- PubMed 근거 링크(있을 경우)

> MVP에서는 “정량 발현 데이터가 부족할 수 있으므로” HPA를 기반으로 카테고리(High/Medium/Low)로 점수화

---

## 7. UI 설계 반영 (사용자/어드민이 ‘실행’할 수 있게)

## 7.1 ADMIN 메뉴 추가(필수)
- Domain Library (Seeds)
- Data Ingestion (Sync)
- (추가) Calculations ✅ 신규 권장
  - RDKit 계산 실행/재시도/버전 관리
  - “규칙 파라미터(임계치) 관리”

### 7.2 ADMIN > Calculations (/admin/calculations)
#### A) 실행 패널
- Run 선택(최근 Ingestion Run)
- 계산 대상 선택
  - Payload RDKit
  - Toxicity Alerts
  - Bystander Proxy
  - Multi-specific Applicability
- [실행 시작] [재시도] [로그]

#### B) 규칙/임계치 관리(Parameters)
- aggregation thresholds
- bystander thresholds
- alert rule sets version
- 가중치 preset(균형/보수적/공격적)

---

## 7.3 사용자 결과 화면(Results Explorer에 카드 추가)
### Payload 상세 카드
- RDKit 물성표
- Aggregation Risk Score + 트리거 규칙
- Toxicity Alerts(배지 형태)
- Bystander Proxy Score
- 근거 링크(PubMed/openFDA 등)

### Multi-specific 추천 탭
- 후보 Pair 목록 (A,B)
- bsAb 적용 점수
- 위험 조직(Top 3)
- 내부화 근거 여부
- “근거 보기” 드로어(문장/링크)

---

## 8. 운영/버전 관리(현실적인 필수 요소)
- Rule set versioning
  - pains_rules_v1, reactive_rules_v1 등
- 계산 결과에 version 저장
  - computed_version 컬럼 추가 권장
- 재계산 정책
  - Rule 변경 시: 선택 Run에 대해 재계산 버튼 제공

---

## 9. MVP 단계별 로드맵(권장)
### Phase 1 (즉시 적용 가능)
- RDKit descriptors 계산 + aggregation_score + bystander_proxy_score
- toxicity_alerts(PAINS/Reactive) 규칙 적용
- UI에 점수/알럿/근거 표시
- Admin에 Calculations 메뉴 추가

### Phase 2 (운영 고도화)
- Multi-specific 적용성 스코어(조직 발현/내부화 룰 중심)
- HPA/UniProt 기반 정규화 강화
- 파라미터 프리셋(보수/균형/공격)

### Phase 3 (정밀 예측)
- 독성/응집/투과성 관련 QSAR/ML 모델 추가
- 레이블 축적 기반 bystander/bsAb 성공확률 모델

---

## 10. 최종 산출물(리포트에 들어갈 “결정용 표준 섹션”)
- Payload 후보 TOP N
  - Aggregation Risk / Toxicity Alerts / Bystander Proxy
- Target 후보 TOP N
  - Selectivity / Expression risk / Evidence strength
- Multi-specific 후보 Pair TOP N
  - Applicability Score / 주요 리스크 조직 / 근거 링크
- 추천 조합 3~5개
  - “추천 이유”와 “리스크/완화 전략(링커 변경/페이로드 변경 등)”

---
