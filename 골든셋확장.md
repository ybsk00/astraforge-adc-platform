# [ADC Platform] Golden Set 자동화 파이프라인 (Admin Review + RAG/LLM 제안) — AntiGravity 실행용 MD
버전: v1.0  
작성일: 2026-01-15  
목표: “암종 → (ClinicalTrials 기반) ADC 후보 수집 → 구성요소(표적/항체/링커/페이로드) 채우기 → SMILES/Proxy 제안 → Review Queue 승인 → Final 승격”의 **버튼 기반 연속 파이프라인**을 MVP로 구현한다.  
핵심 원칙: **LLM은 ‘근거 포함 제안’만** 한다. DB에 자동 확정 저장(Overwrite)은 금지. 모든 반영은 **Review Queue 승인 후**.

---

## 0. 범위/정책 (MVP 확정)
### 0.1 포함(Phase 1)
- Admin UI에서 Step 버튼 3개 + 승격 버튼(옵션)
- Candidate 수집: ClinicalTrials.gov v2 API (암종+ADC 관련 키워드)
- Target Resolver: 동의어 사전 기반 (HGNC 기반 확장 가능)
- 구성요소 추출: Rule 기반 + (선택) LLM 보조 (단, Proposed로만)
- SMILES 채우기: PubChem 우선 (CID 기반)
- 실패 시 Proxy SMILES: **LLM이 후보 평가/근거 작성** (단, Proposed로만)
- Review Queue (Diff View 포함) + 승인/거절 + 패치 반영
- Verified Lock(보호) / Overwrite Protection

### 0.2 제외(Phase 2)
- RDKit 계산 및 linker/payload 안정성 시뮬레이션(별도 job)
- 특허 Chem-OCR(Phase 2 로드맵)

### 0.3 Gate 정책 (옵션 C 채택)
- 승격 필수 Gate:  
  1) resolved_target_symbol 존재  
  2) payload_smiles_standardized 존재 **또는** proxy_smiles_flag = true  
  3) evidence_refs >= 1  
- **clinical_nct_id_primary는 승격 필수 아님(옵션 C)**  
  - 단, 추후 임상 동기화 필요 시 입력 권장(Recommended)

---

## 1. 전체 사용자 플로우 (버튼 기반 파이프라인)
### 1.1 Admin 화면: `/admin/golden-sets`
탭 구성(권장):
- Tab 1: **Auto (Candidate Pipeline)** → `golden_candidates` 기반
- Tab 2: **Manual (Seed / Verified)** → `golden_seed_items` 기반
- Tab 3: **Review Queue** → `golden_review_queue` 기반
- Tab 4: **Final (Golden Set)** → `golden_final_items` 기반

### 1.2 Auto 탭 Step 버튼
#### Step 1 — “골든셋 로우데이터 찾기”
- 입력: cancer_type(암종), optional target_list(선택), date_range(선택)
- 동작: ClinicalTrials.gov에서 “ADC + Oncology” 후보 수집 → `golden_candidates` upsert
- 출력: 후보 리스트 (drug/program 후보명, nct 목록, interventions text snippet, score)

#### Step 2 — “표적/링커/페이로드 채우기”
- 입력: 후보 선택(멀티) 또는 “전체”
- 동작:
  - 2-1) resolve_ids_job: target 동의어 사전 적용 → resolved_target_symbol 산출
  - 2-2) extraction_job: interventions/summary에서 linker/payload 후보 텍스트 추출
  - 결과를 DB에 직접 덮어쓰기 금지 → `golden_review_queue`에 **proposed_patch**로 적재
- 출력: Review Queue에 “변경 제안” 생성(승인 대기)

#### Step 3 — “SMILES 찾기 (PubChem/ChEMBL)”
- 입력: Review 승인되어 확정된 payload/linker 이름(또는 후보 텍스트)
- 동작:
  - PubChem 검색 → CID → SMILES 확보(가능하면 IsomericSMILES)
  - 실패 시 Proxy 제안:
    - (중요) LLM은 **‘이미 제시된 후보(CID/ChEMBL ID/대표 약물명)’를 평가**하고 근거 작성
    - 임의 SMILES 생성 금지
  - 결과는 DB 덮어쓰기 금지 → `golden_review_queue`에 proposed_patch로 적재
- 출력: Review Queue “SMILES/Proxy 제안” 생성

#### Step 4 — “승격 (Final)”
- Gate 통과 시 활성화
- 동작: `golden_seed_items` 또는 승인된 Candidate를 `golden_final_items`로 스냅샷 복제

---

## 2. 데이터 모델 / DB 스키마 (Supabase Postgres)
> 기존 `golden_candidates`는 유지하되, “수동 Seed/Review/Final”을 분리 운영한다.

### 2.1 테이블: `golden_candidates` (기존/확장)
목적: ClinicalTrials 기반 raw 후보 저장
필드(권장 확장):
- id (uuid pk)
- cancer_type (text)
- drug_name_raw (text)
- drug_name_canonical (text, nullable)
- nct_ids (text[] or jsonb)
- interventions_raw (jsonb)  # CT interventions/arm info
- summary_raw (text)
- extracted_target_raw (text, nullable)
- extracted_payload_raw (text, nullable)
- extracted_linker_raw (text, nullable)
- match_score (float)
- evidence_refs (jsonb) # [{type:"CT", id:"NCTxxxx", snippet:"...", url:"..."}]
- created_at, updated_at

### 2.2 테이블: `golden_seed_items` (Admin 수동 입력/검증)
목적: Manual Seed(20개) + Admin 확정 데이터 저장(Overwrite 보호 대상)
필드(최소):
- id (uuid pk)
- portfolio_group (text) # Group A/B/C/D 등
- drug_name_canonical (text)
- aliases (text)
- target (text)
- resolved_target_symbol (text) # 예: HER2 → ERBB2
- antibody (text)
- linker_family (text)
- linker_trigger (text)
- payload_family (text)
- payload_exact_name (text)
- payload_smiles_standardized (text) # 없으면 proxy로 대체 가능
- proxy_smiles_flag (bool default false)
- proxy_reference (text)
- clinical_phase (text)
- program_status (text)
- outcome_label (text)
- key_risk_category (text)
- key_risk_signal (text)
- failure_mode (text)
- evidence_refs (jsonb default '[]') # [{type:"BLA|PMID|NCT|URL", id:"...", snippet:"...", url:"..."}]
- clinical_nct_id_primary (text nullable) # 옵션 C: 승격 필수 아님
- verified_lock (bool default false)  # Admin 확정 잠금(자동 덮어쓰기 금지)
- verified_fields (jsonb default '{}') # 선택: 필드별 검증 플래그(확장)
- created_at, updated_at

### 2.3 테이블: `golden_review_queue` (핵심)
목적: 워커가 만든 변경 제안을 Admin이 승인/거절
필드:
- id (uuid pk)
- entity_type (text) # "candidate" | "seed"
- entity_id (uuid)
- job_name (text) # 예: ct_candidates_job, resolve_ids_job, smiles_fetch_job, proxy_llm_job
- proposed_patch (jsonb) # {"payload_exact_name":"DXd", "payload_smiles_standardized":"..."}
- evidence_refs (jsonb default '[]')
- diff_summary (text) # UI 표시용
- status (text) # "pending" | "approved" | "rejected"
- approved_by (text nullable)
- approved_at (timestamptz nullable)
- created_at (timestamptz)

### 2.4 테이블: `golden_final_items` (승격된 최종 골든셋 스냅샷)
목적: 모델 학습/리포트/검증에 사용하는 “정답지”
필드:
- id (uuid pk)
- seed_id (uuid nullable) # 원본 seed 참조
- snapshot (jsonb) # seed 전체 row 스냅샷(불변)
- gate_status (jsonb) # 어떤 gate 통과했는지 기록
- promoted_by, promoted_at

### 2.5 권장 인덱스
- golden_seed_items(drug_name_canonical)
- golden_seed_items(resolved_target_symbol)
- golden_review_queue(entity_type, entity_id, status)
- golden_candidates(cancer_type, updated_at)

---

## 3. API 설계 (Next.js Route Handlers)
기본 규칙:
- 모든 Step 실행은 서버 API에서 수행
- Step 실행 결과는 “직접 반영”이 아니라 “Review Queue에 제안 적재”가 기본

### 3.1 Step 1: 후보 수집
- POST `/api/admin/golden/run-candidates`
Request:
```json
{
  "cancer_type": "breast cancer",
  "target_list": ["HER2","TROP2"],
  "date_range": {"from":"2020-01-01","to":"2026-01-01"},
  "limit": 200
}
Behavior:

ClinicalTrials.gov v2 검색(키워드 = cancer_type AND (ADC terms))

결과 파싱 후 golden_candidates upsert

evidence_refs에 NCT 및 source url 저장
Response:

json
코드 복사
{"status":"ok","inserted":120,"updated":35}
3.2 Step 2: 구성요소 채우기(제안 생성)
POST /api/admin/golden/run-enrich-components
Request:

json
코드 복사
{"candidate_ids":["uuid1","uuid2"],"use_llm_assist":true}
Behavior:

resolve_ids_job로 target 표준화 제안

interventions/summary에서 payload/linker 후보 추출

결과를 golden_review_queue에 pending으로 적재

seed(verified_lock=true)는 절대 overwrite 금지 → 제안만 생성
Response:

json
코드 복사
{"status":"ok","proposals_created":48}
3.3 Step 3: SMILES 채우기(제안 생성)
POST /api/admin/golden/run-enrich-smiles
Request:

json
코드 복사
{"entity_type":"seed","entity_ids":["seed_uuid1"],"mode":"pubchem_then_proxy"}
Behavior:

payload_exact_name/linker 명칭으로 PubChem 조회

성공: smiles를 proposed_patch로 queue 적재

실패: proxy_llm_job이 “후보 평가+근거” 형태로 proposed_patch 생성
Response:

json
코드 복사
{"status":"ok","smiles_found":12,"proxy_proposed":8}
3.4 Review 승인/거절
POST /api/admin/golden/review/approve
Request: {"review_id":"uuid","approved_by":"admin@..."}
Behavior:

status=approved로 변경

entity row에 patch 반영(단, verified_lock 보호 규칙 적용)

diff 기록 저장

POST /api/admin/golden/review/reject

3.5 승격
POST /api/admin/golden/promote
Request: {"seed_ids":["..."],"promoted_by":"admin@..."}
Behavior:

Gate 통과 여부 계산(옵션 C 적용)

통과 시 golden_final_items에 snapshot 생성

4. Worker/Job 설계 (Docker Local Backend 기준)
현재 로컬 Docker(127.0.0.1:8000) 사용 중이므로, Next.js는 “backend API base url”을 환경변수로 읽는다.

4.1 공통 규칙
모든 job은 idempotent(재실행 시 중복 최소화)

모든 job 결과는 job_runs(선택) 또는 기존 로그로 추적 가능

verified_lock 레코드는 자동 반영 금지(Review Queue로만)

4.2 Job 목록
ct_candidates_job

입력: cancer_type, keywords

출력: golden_candidates upsert

resolve_ids_job

입력: target text

출력: resolved_target_symbol 제안

동의어 사전(synonym_dict) 우선 → 없으면 “unmapped”로 큐/리스트 제공

extract_components_job

입력: interventions_raw, summary_raw

출력: payload/linker/antibody 후보 제안 + evidence snippet

pubchem_smiles_job

입력: payload_exact_name/linker 후보명

출력: CID + SMILES 제안 + evidence(url, cid)

proxy_llm_job (LLM 사용)

입력: (필수) “후보 Proxy(예: Belotecan CID)” + 약물 컨텍스트

출력: “이 후보를 Proxy로 쓰는 것이 타당한가” + 근거 + 제한사항 + proposed_patch(proxy flag/ref)

금지: 임의 SMILES 생성/확정 저장

5. LLM/RAG 사용 규칙 (안전한 설계)
5.1 LLM 역할(허용)
텍스트에서 구성요소 후보 “추출”

Proxy 후보 “평가/근거 작성”(후보가 사전에 주어져야 함)

Evidence 요약(짧고 검증 가능하게)

5.2 LLM 금지
근거 없는 구성요소 단정 저장

임의 SMILES 생성 및 자동 저장

verified_lock 레코드 덮어쓰기

5.3 Good Prompt 템플릿(Proxy 평가)
입력에 최소 1개 이상의 후보(CID/ChEMBL ID)를 반드시 포함
예:

“MK-2870의 payload는 ‘Belotecan derivative’로 알려져 있다. PubChem에 공개된 Belotecan(CID: 6918464)을 Proxy로 사용하는 것이 타당한가? 타당하다면 근거 3개와 한계(Proxy임을 명시) 2개를 제시하라. 최종 출력은 JSON으로 (is_proxy=true, proxy_reference, evidence_refs[]) 형태로 작성하라.”

6. Admin 프로세스 (운영 방식)
6.1 일일 운영 루틴(추천)
Auto 탭에서 Step1 실행(암종별)

후보 목록에서 “관심 후보” 체크 후 Step2 실행

Review Queue에서 Diff 확인 → 승인/거절

승인된 seed/candidate에 대해 Step3 실행 → SMILES/Proxy 제안 생성

Review Queue 승인

Gate 통과 확인 후 승격(Final)

6.2 Admin이 채워야 하는 필드(옵션 C 기준)
필수:

resolved_target_symbol

payload_smiles_standardized OR proxy_smiles_flag=true + proxy_reference

evidence_refs >= 1

권장:

clinical_nct_id_primary (있으면 임상 동기화/추적에 유리)

7. UI 요구사항 (구현 체크리스트)
7.1 /admin/golden-sets (Tabs)
Tab Auto: Candidate 목록 + Step1/2/3 버튼

Tab Manual: Seed 목록 + 편집(상세 페이지) + Verified Lock 토글

Tab Review Queue: pending 리스트 + Diff View + 승인/거절

Tab Final: 최종 스냅샷 리스트 + 다운로드/리포트(추후)

7.2 Candidate Table (Auto)
컬럼:

drug_name_raw / canonical

cancer_type

nct_count

match_score

extracted_target_raw

extracted_payload_raw

updated_at
액션:

체크박스 선택

Step2 실행(선택 대상)

상세 보기(원문 snippets/evidence_refs)

7.3 Review Queue (Diff View 필수)
행: entity, job_name, diff_summary, evidence_refs count, status

상세: old_value vs new_value

old: 회색, new: 초록, 삭제/변경: 빨강

버튼: Approve / Reject

보호: verified_lock=true이면 “직접 반영 금지” 안내 배지 표시(그래도 approve는 patch 반영이 아니라 ‘검토 완료’로 처리하거나 별도 정책)

7.4 Manual Seed 상세 편집 (Gate Checklist)
Gate Checklist 4개(옵션 C에서는 3개만 필수 표시)

Target Resolved ✅

SMILES Ready ✅

Evidence ✅

Primary NCT (Optional)

저장 시: evidence_refs 입력 UI(배열)

8. 환경설정 (로컬 Docker 연동)
8.1 문제: ECONNREFUSED 127.0.0.1:8000
의미:

Next.js가 backend(로컬 docker)로 fetch했는데 서버가 꺼져있거나 포트 매핑이 끊김

8.2 권장 구성
.env.local

ini
코드 복사
BACKEND_BASE_URL=http://127.0.0.1:8000
SUPABASE_URL=...
SUPABASE_SERVICE_ROLE_KEY=...
LLM_API_KEY=...
Next.js route handler에서 fetch 시:

base url은 env로만 참조(하드코딩 금지)

타임아웃/리트라이(짧게 1~2회) 적용

실패 시 UI에 “backend down” 표기

9. 구현 우선순위 (AntiGravity 작업 순서)
Day 1
DB 스키마 생성: golden_seed_items / golden_review_queue / golden_final_items

Admin Tabs 페이지 골격 + 목록 로딩

Day 2
Step1 API + ClinicalTrials 후보 수집 + golden_candidates upsert

Candidate Table 표시

Day 3
Step2 API + resolve_ids_job + extract_components_job → Review Queue 생성

Review Queue UI + Diff View + Approve/Reject

Day 4
Step3 API + PubChem SMILES 조회 → Review Queue 생성

Proxy LLM job(근거 포함) → Review Queue 생성

Day 5
Gate 체크 + 승격(promote) + Final 리스트

10. 성공 기준(완료 Definition)
Admin이 암종 입력 후 Step1~3를 실행하면:

후보가 생성되고

구성요소/SMILES가 “제안”으로 쌓이며

Review 승인 후 seed에 반영되고

Gate 통과 시 Final로 승격된다.

verified_lock 레코드는 자동 덮어쓰기 없이 보호된다.

Proxy는 반드시 proxy_flag 및 proxy_reference, evidence_refs를 동반한다.

11. 참고: ADC 키워드 세트(ClinicalTrials 검색용)
"antibody-drug conjugate" OR "antibody drug conjugate" OR "ADC" OR "immunoconjugate" OR "antibody conjugate"

oncology terms: "cancer" OR "tumor" OR "carcinoma" OR 암종명(cancer_type)

(선택) target hints: ERBB2, TACSTD2, NECTIN4 등 resolved_target_symbol 기반