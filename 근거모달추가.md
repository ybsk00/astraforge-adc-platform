# Golden Set 상세 페이지: “근거 보기(Evidence)” 모달 추가 구현 가이드 (MD)

목표
- 검토자가 Golden Set 후보를 보면서 “왜 이 후보가 골든셋에 들어왔는지”를 판단할 수 있도록,
- Golden Set 상세 페이지(`/admin/golden-sets/[id]`)에 **Evidence(근거) 보기 모달**을 추가한다.
- 후보(=golden_candidate) 행마다 “근거 보기” 버튼을 제공하고, 클릭 시 근거 목록을 모달로 표시한다.

---

## 1) 데이터 모델 전제 (권장)
Evidence는 아래 두 방식 중 하나로 제공되어야 한다.

### 옵션 A (권장): 테이블 분리
- `golden_candidate_evidence`
  - `id` (uuid)
  - `candidate_id` (uuid, FK -> golden_candidates.id)
  - `source` (text) : clinicaltrials | pubmed | patent | uniprot | opentargets
  - `ref_id` (text) : NCTxxxx | PMIDxxxx | PatentNo | UniProtAcc ...
  - `url` (text) : 클릭 가능한 링크
  - `snippet` (text) : 1~2줄 요약
  - `created_at`

장점: 검색/필터/정렬/집계가 쉽고 UI 구성에 최적.

### 옵션 B: jsonb 컬럼
- `golden_candidates.evidence_json` (jsonb)
  - 예: `[{"source":"clinicaltrials","ref_id":"NCT...","url":"...","snippet":"..."}]`

장점: 빠른 MVP
단점: 검색/필터가 불리하고 구조 변경이 어려움.

본 문서는 **옵션 A(테이블 분리)** 기준으로 UI를 설계하며,
옵션 B를 쓰는 경우엔 API에서 동일한 형태로 변환해서 내려주면 된다.

---

## 2) API 설계 (Next.js Route 또는 Server Action)
모달은 “candidate_id 기준”으로 근거를 가져온다.

### 2.1 Endpoint
- `GET /api/admin/golden-sets/candidates/{candidateId}/evidence`

### 2.2 Response (표준 형태)
```json
{
  "candidate_id": "uuid",
  "evidence": [
    {
      "source": "clinicaltrials",
      "ref_id": "NCT01234567",
      "url": "https://clinicaltrials.gov/study/NCT01234567",
      "snippet": "ADC trial in HER2-positive breast cancer..."
    },
    {
      "source": "pubmed",
      "ref_id": "PMID12345678",
      "url": "https://pubmed.ncbi.nlm.nih.gov/12345678/",
      "snippet": "Trastuzumab emtansine mechanism and efficacy..."
    }
  ]
}
2.3 Query 옵션(권장)
?source=pubmed (선택)

?limit=50 (선택)

3) UI/UX 요구사항 (상세 페이지 내 Evidence 모달)
3.1 후보 리스트 행(Row) 버튼 추가
후보 리스트(100개)에서 각 row 오른쪽 action에:

근거 보기 버튼(또는 아이콘 버튼)

3.2 모달 동작
버튼 클릭 → 해당 candidate의 evidence 로드 → 모달 오픈

모달 구성:

상단: 후보 요약(Drug Name / Target / Linker / Payload)

탭 또는 필터: All / ClinicalTrials / PubMed / Patent

Evidence 리스트:

source badge

ref_id (클릭 시 새 탭으로 URL 열기)

snippet 1~2줄

하단: “닫기” 버튼

3.3 상태 처리
로딩: Skeleton/Spinner

에러: “근거를 불러오지 못했습니다” + 재시도

근거 없음: “등록된 근거가 없습니다(게이트 조건 확인 필요)”

4) 프론트엔드 구현 상세 (React/Next.js, V0 스타일 다크 UI)
4.1 컴포넌트 추가
components/admin/EvidenceModal.tsx (신규)

components/admin/EvidenceButton.tsx (선택, 버튼 + 모달 트리거 분리)

EvidenceModal Props (권장)
open: boolean

onOpenChange(open:boolean)

candidate: { id, drug_name, target, antibody, linker, payload }

initialSource?: 'all'|'clinicaltrials'|'pubmed'|'patent'...

4.2 상태 설계
selectedCandidate (row에서 선택된 candidate)

evidenceOpen (모달 열림 여부)

evidenceItems (로딩된 근거 배열)

loading / error

sourceFilter

4.3 데이터 로딩 패턴
모달이 열릴 때(또는 candidate가 바뀔 때) 1회 로드:

fetch('/api/admin/golden-sets/candidates/${id}/evidence')

캐시(권장): candidate_id별로 Map 캐시를 두어 재오픈 시 즉시 표시

5) 예시 UI 구성(텍스트 기준)
5.1 후보 리스트 테이블 컬럼(예시)
drug_name | target | antibody | linker | payload | status | actions
actions:

“근거 보기”

“Approve/Reject” (있다면)

5.2 Evidence 모달 레이아웃
Title: “근거 보기 (Evidence)”

Subtitle: “이 후보가 골든셋에 포함된 근거를 확인합니다.”

Candidate Summary Card:

Drug: Kadcyla

Target: HER2

Linker: Non-cleavable

Payload: DM1

Filters:

All / ClinicalTrials / PubMed / Patent

Evidence List:

[ClinicalTrials] NCTxxxxxxx — snippet...

[PubMed] PMIDxxxxxxx — snippet...

Footer:

Close

6) 백엔드 구현(예시, Supabase)
6.1 Evidence 조회 SQL 개념
sql
코드 복사
select source, ref_id, url, snippet
from golden_candidate_evidence
where candidate_id = :candidate_id
order by
  case source
    when 'clinicaltrials' then 1
    when 'pubmed' then 2
    else 9
  end,
  ref_id asc;
6.2 API Route 로직(의사코드)
candidate_id 검증

golden_candidate_evidence 조회

evidence 배열 반환

오류 시 500 + 메시지

보안:

관리자만 접근 가능(현재 admin 인증 방식에 맞춰 보호)

RLS가 켜져 있다면 service role 또는 admin role 정책 필요

7) 검증(Verification)
7.1 기능 검증
후보 1개 클릭 → 모달 오픈 → 근거가 최소 2개 표시되는지(게이트 기준)

URL 클릭 시 새 탭으로 열리는지

source 필터가 정상 동작하는지

7.2 예외 케이스
evidence 0개: “근거 없음” 안내 + 게이트/파이프라인 점검 경고

API 실패: 에러 UI + 재시도 버튼

대량 데이터: evidence 50개 제한 + 더보기(옵션)

8) 권장 개선(후순위)
Evidence에 “이 근거가 어떤 구성요소를 뒷받침하는지” 태그

예: supports: target|payload|linker|clinical

Evidence 스니펫 자동 요약(워커 단계에서 생성)

“근거 기반 승인” 워크플로우:

evidence 최소 2개 확인 후 approve 가능하도록 UI 제약

9) 체크리스트
 golden_candidate_evidence 테이블 존재(또는 evidence_json)

 candidate row에 “근거 보기” 버튼 추가

 EvidenceModal 구현(로딩/에러/없음 상태 포함)

 API Route 구현 및 관리자 권한 보호

 링크 새 탭 오픈 처리

 필터(All/Source별) 동작

10) Done 기준(Definition of Done)
Golden Set 상세에서 후보 100개 중 아무거나 “근거 보기” 클릭 시

근거가 모달에 최소 2개 이상 표시되고

각 ref는 외부 URL로 이동 가능하며

에러/없음 상태도 UX가 깨지지 않는다.

markdown
코드 복사
