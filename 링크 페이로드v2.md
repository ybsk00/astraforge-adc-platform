# 문헌 기반 RAG로 ADC 설계용 링커·페이로드를 “가져오는” 설계안 (MD)

## 0. 목표와 결론
### 목표
- 문헌(논문/리뷰/오픈액세스/특허)에서 **ADC 설계에 필요한 링커(linker)와 페이로드(payload)** 정보를 자동 수집·정리하고,
- ADC 조합 설계 엔진에서 **안전하게 재사용 가능한 “구조화 카탈로그(Catalog)”**로 축적하며,
- 각 후보에 대해 **과학적 근거(Evidence)와 리스크**를 함께 보고서로 출력한다.

### 핵심 결론 (운영 원칙)
- **RAG는 “후보 언급 + 근거 회수 + 요약(설명)” 역할에 최적**이다.
- **정확한 구조(예: SMILES/InChI) 확정은 RAG 단독으로 불가/위험**하므로,
  - 구조화 DB/특허 기반 원문에서 **식별자·구조를 확정**하고
  - 설계 엔진은 **확정된 카탈로그 엔티티만 사용**하도록 “가드레일”을 둔다.
- 즉, **RAG(증거) + Catalog(정답)**를 분리하는 것이 안전하고 확장성이 높다.

---

## 1. 범위 정의: RAG로 가능한 것 vs. 어려운 것
### 1.1 RAG로 잘되는 범위 (추천)
- 링커/페이로드 **명칭, 약어, 동의어, 조합 패턴** 추출
- 링커 속성 태깅:
  - cleavable vs non-cleavable
  - 절단 트리거(예: cathepsin B, pH, GSH 등)
  - 스페이서 유무(PABC 등), 방출 논리
- 페이로드 속성 태깅:
  - payload class(auristatin, maytansinoid, camptothecin, PBD 등)
  - permeability/방관자 효과(by-stander effect) 관련 단서
  - 독성/용량 제한/오프타깃 이슈(서술형 근거)
- “왜 적합한가”에 대한 **근거 문장 + 인용** 중심 리포트

### 1.2 RAG만으로 위험한 범위 (분리 권장)
- 정확한 화학 구조(구조식/SMILES/InChI) 확정
- 동일 물질 판정(표기 변형/특허 코드/상표명 혼재)
- 접합 위치/핸들/결합 방식(예: maleimide–thiol, SPAAC 등)까지 완전 자동 확정
- “문헌에 없는 구조를 생성”하는 환각(hallucination)

---

## 2. 전체 아키텍처(권장): Evidence RAG + Structure Catalog
### 2.1 구성요소
- **Connectors (수집)**: PubMed, PMC(Open Access), Google Patents(가능 시), 기타 오픈 리뷰/프리프린트
- **Chunking + Index (RAG)**: 문헌/특허 텍스트를 청킹 후 벡터+키워드 인덱싱(Supabase pgvector 등)
- **Entity Extractor (NLP/LLM)**: 링커/페이로드 후보명 및 속성 슬롯 추출
- **Normalizer/Resolver (정규화)**: 동의어/약어를 표준 엔티티로 매핑(수동 검수 포함)
- **Catalog DB (정답 저장소)**: 확정된 링커/페이로드 엔티티(가능하면 SMILES 등 포함)
- **Evidence DB (근거 저장소)**: 출처, 인용 문장, 실험 조건, 주석
- **Design Engine (설계)**: 카탈로그 기반 조합 생성 + RAG 근거 attach + 리스크/적합성 평가 + 보고서

### 2.2 데이터 흐름(요약)
1) Seed(골든셋) 로딩 → 2) 문헌 수집/인덱싱 → 3) 후보 추출 →  
4) 정규화/카탈로그 확정(검수) → 5) 설계 시 카탈로그만 사용 →  
6) 근거/리스크 포함 보고서 출력

---

## 3. 데이터 모델(권장) — Supabase 기준
아래는 “설계 엔진 안전성”을 위해 **Catalog(정답)**과 **Evidence(근거)**를 분리하는 스키마입니다.

### 3.1 Catalog: 링커
- `entity_linkers`
  - `id` (uuid, pk)
  - `canonical_name` (text, unique) — 표준명
  - `synonyms` (text[]) — 동의어/약어 리스트
  - `linker_type` (enum: cleavable, non_cleavable, spacer_only, handle_only 등)
  - `cleavage_trigger` (text, nullable) — cathepsin, pH, GSH 등
  - `chem_handle` (text, nullable) — maleimide, NHS-ester, azide/alkyne 등
  - `has_pabc` (bool, default false)
  - `smiles` (text, nullable) — 가능하면 저장 (없어도 운영 가능)
  - `inchi_key` (text, nullable)
  - `source_confidence` (int 0~100) — 구조 확정 신뢰도
  - `created_at`, `updated_at`

### 3.2 Catalog: 페이로드(약물)
- `entity_drugs` (이미 payload로 활용 중이라면 확장)
  - `id` (uuid, pk)
  - `canonical_name` (text, unique)
  - `synonyms` (text[])
  - `payload_class` (text) — auristatin, maytansinoid, SN-38 등
  - `mechanism` (text, nullable) — microtubule inhibitor 등
  - `membrane_permeability_note` (text, nullable)
  - `bystander_potential` (enum: low/medium/high/unknown)
  - `smiles` / `inchi_key` (nullable)
  - `toxicity_flags` (jsonb) — 대표 독성/주의사항 태그
  - `source_confidence` (int 0~100)
  - `created_at`, `updated_at`

### 3.3 Seed Set과 연결(사용자 선택용)
- `seed_sets`
- `seed_set_linkers`
  - `seed_set_id` (fk)
  - `linker_id` (fk)
  - `role` (enum: preferred, optional, excluded 등)
- `seed_set_payloads` (또는 `seed_set_drugs`)
  - `seed_set_id` (fk)
  - `drug_id` (fk)
  - `role` (enum)

### 3.4 Evidence: “근거는 모두 여기”
- `evidence_snippets`
  - `id` (uuid)
  - `source_type` (enum: pubmed, pmc, patent, web)
  - `source_id` (text) — PMID/PMCID/특허번호/URL 등
  - `title` (text)
  - `year` (int, nullable)
  - `chunk_id` (text) — 인덱싱된 청크 식별자
  - `quote` (text) — 근거 문장(짧게)
  - `context` (text) — 주변 문맥(요약)
  - `extracted_entities` (jsonb) — linker/payload 후보 및 슬롯
  - `quality_score` (int 0~100) — 논문 타입/샘플/재현성 등 룰 기반
  - `created_at`

- `entity_evidence_map`
  - `entity_type` (enum: linker, payload)
  - `entity_id` (uuid)
  - `evidence_id` (uuid)
  - `relation` (enum: supports, warns, contraindicates, mechanism, toxicity)
  - `notes` (text)

> 운영 팁: “설계 결과 리포트”는 entity_evidence_map을 조인하여 자동으로 근거를 끌어옵니다.

---

## 4. RAG 인덱싱 설계(문헌/특허)
### 4.1 청킹 전략(권장)
- 섹션 기반 우선: Abstract / Methods / Results / Discussion / Claims(특허)
- 청크 크기: 600~1200 tokens (도메인 문장 길이 고려)
- 메타데이터:
  - PMID/PMCID/PatentNo, year, journal, section, authors(가능 시)
  - 키워드: “linker”, “payload”, “antibody-drug conjugate”, “cleavable” 등

### 4.2 Retrieval 전략(권장)
- Hybrid Search: Vector + Keyword(BM25 유사)
- 질의 템플릿 예시:
  - “{payload} bystander effect ADC evidence”
  - “val-cit PABC linker stability plasma”
  - “non-cleavable linker lysine-MCC DM1 properties”

### 4.3 LLM 출력 제한(가드레일)
- **“새 화학 구조 생성 금지”**
- 구조(SMILES/InChI) 필드는:
  - (a) 외부 구조 DB에서 확인된 경우에만 채움
  - (b) 아니면 `null` 유지 + “구조 미확정” 경고

---

## 5. 엔티티 추출 및 정규화(핵심 난이도)
### 5.1 후보 추출(LLM/NLP)
- 문헌에서 다음을 추출:
  - Entity: linker/payload 명칭, 약어, 변형 표기
  - 슬롯: cleavable 여부, trigger, spacer, payload class, bystander 단서, toxicity 단서
- 출력은 **JSON 스키마 고정**(검증 가능해야 함)

### 5.2 정규화(Resolver) — “동의어 지옥” 해결
- 우선순위:
  1) Seed(골든셋)과 exact/유사 매칭
  2) 동의어 테이블(수동 누적)
  3) 구조 DB에서 canonical id 확정(가능한 경우)
  4) 미확정이면 “검수 대기”로 분리(설계에는 미사용)

- 상태 필드(권장):
  - `status`: `confirmed` | `candidate` | `needs_review` | `rejected`

---

## 6. 설계 엔진에서의 사용 규칙(안전성 제약)
### 6.1 조합 생성 규칙(중요)
- **설계(조합 생성)는 Catalog에서 `status=confirmed` 인 엔티티만 사용**
- RAG에서 새로 등장한 후보는:
  - Evidence로만 저장 → 검수 후 Catalog로 승격 → 그 다음 설계에 반영

### 6.2 리스크/적합성 평가(예시 룰)
- 링커 안정성(혈장 안정성/오프타깃 절단 가능성) 근거가 약하면 리스크 상승
- payload가 강한 막 투과성/방관자 효과 단서가 많으면:
  - 고형암에 유리할 수 있으나 정상조직 독성 리스크 동반 → 트레이드오프 표기
- 목표 적응증/표적 발현 패턴과 함께 “권장/비권장”을 근거 기반으로 출력

---

## 7. UI/운영 플로우(Seed Set + 탭 확장)
### 7.1 Seed Set 관리 페이지
- 탭: `Targets` / `Antibodies` / `Linkers` / `Payloads`
- 기능:
  - 검색/필터: (cleavable, trigger, payload_class, bystander 등)
  - 선택된 항목은 배지 형태로 누적
  - “근거 보기” 버튼: evidence_snippets 카드 모달

### 7.2 카탈로그(링커/페이로드) 관리 페이지(어드민)
- 상태 큐:
  - needs_review(검수 대기)
  - confirmed(설계 사용 가능)
- 검수 시:
  - canonical_name 정리
  - synonyms 추가
  - 구조/식별자 확정(가능 시)
  - confidence 스코어 설정

---

## 8. 보고서 출력(요구사항 반영)
### 8.1 보고서 섹션 템플릿(권장)
1) Executive Summary: 선택 조합 요약 + 핵심 근거
2) Linker 분석
   - 타입/절단 메커니즘/안정성
   - 근거 스니펫 3~7개(출처 포함)
   - 리스크 및 대안
3) Payload 분석
   - 클래스/기전/독성 단서
   - bystander 효과 가능성 근거
4) 조합 적합성 평가
   - 설계 가정(표적, DAR 범위, 방출 조건)
   - 실패 가능성(공학적/화학적)과 완화 전략
5) Appendix
   - Evidence 목록(원문 링크/PMID/특허번호)
   - 용어집

### 8.2 “세부적으로 나와야 한다”를 위한 운영 팁
- 모든 주장에는:
  - Evidence snippet(짧은 인용) + source_id + section 메타데이터
- “계산 근거”가 필요한 항목(RDKit 기반 물성 등)은:
  - 계산 입력(SMILES) 확정된 엔티티에 한해서만 수행
  - 계산 불가 시 “구조 미확정으로 계산 제외”를 명시

---

## 9. 품질/검증 체계(실서비스 관점)
### 9.1 정량 KPI(권장)
- 후보 추출 정밀도(Precision) / 재현율(Recall) — 골든셋 기준
- 엔티티 정규화 정확도(정답 매핑률)
- Evidence 품질 점수 평균(리뷰/임상/전임상 가중치 적용 가능)
- “설계에 실제 사용된 엔티티 중 근거 3개 이상 보유 비율”

### 9.2 운영 가드레일
- 근거가 부족하면 “추천”이 아니라 “후보”로만 분류
- RAG 응답에 구조/수치가 등장할 경우:
  - 반드시 출처 기반인지 검증(출처 없는 수치/구조는 차단)

---

## 10. 구현 단계(권장 로드맵)
### Phase 1 (MVP 안전형, 2~3주)
- `entity_linkers`, `seed_set_linkers`, evidence 테이블 구축
- Seed(골든셋) 수동 입력 + Seed Set 탭 UI 연결
- RAG 인덱싱(논문 텍스트) + “근거 카드”만 자동 생성

### Phase 2 (확장, 3~6주)
- 후보 추출 자동화(LLM JSON 추출)
- 정규화 워크플로우(검수 큐/승격)
- payload 카탈로그 확장 및 설계 엔진에 “카탈로그만 허용” 적용

### Phase 3 (고도화, 6주~)
- 특허/구조 DB 연동(가능 범위 내)
- RDKit 계산(구조 확정 엔티티에 한함)
- 보고서 자동화(표/이미지/근거 하이라이트)

---

## 11. 체크리스트(실행 전 점검)
- [ ] 설계 엔진이 “confirmed 카탈로그 엔티티만” 사용하도록 강제했는가?
- [ ] Evidence와 Catalog가 물리적으로 분리되어 있는가?
- [ ] 후보 추출 결과가 JSON 스키마 검증을 통과하는가?
- [ ] 출처 없는 구조/수치 생성이 차단되는가?
- [ ] Seed Set UI에서 링커/페이로드 탭이 정상 동작하는가?
- [ ] 보고서에 근거(출처/문장)가 자동 포함되는가?

---

## 12. 최종 요약
- 문헌 기반 RAG는 링커/페이로드 “가져오기”에 매우 유효하지만,
- **구조·ID 확정(정답)은 별도 카탈로그로 관리**해야 하며,
- 설계 엔진은 **카탈로그 기반 조합 + RAG 근거 attach** 구조로 운영하는 것이
  환각 리스크를 최소화하면서 확장성을 확보하는 정석 설계다.
