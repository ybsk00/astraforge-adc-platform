# Phase 17 확장: 링커 및 페이로드 관리(Seed Set) 구현 보완안 (구체화 MD)

본 문서는 제안하신 Phase 17 확장(링커 테이블 신설, 페이로드 Seed 포함, Seed Set UI 통합)을 **운영 가능한 수준**으로 보완·구체화한 구현 계획입니다.  
목표는 “표적/질환만 존재하던 Seed Set”을 **ADC 조합 설계가 가능한 최소 카탈로그**로 확장하는 것입니다.

---

## 0. 핵심 결론(보완 포인트 요약)

현재 계획은 방향이 정확합니다. 다만 실제 구현에서 막히는 지점이 아래 6가지로 반복됩니다.

1) **링커를 ‘엔티티’로만 만들고, Seed Set과의 관계를 누락**하면 조합 설계가 안 됨  
2) 페이로드(entity_drugs) 연동 시 **“payload vs 일반 drug” 구분 필드**가 없으면 데이터가 섞임  
3) Seed Set 생성 모달에서 다중 선택이 늘어나면 **UI/성능/UX(검색·배지·삭제) 표준화**가 필요  
4) RLS/권한 정책이 없으면 “사용자가 카탈로그를 수정”하는 사고가 발생  
5) 커넥터 실행 후 적재 테이블 검증을 하려면 **Run/Job 상태 테이블과 로깅 기준**이 명확해야 함  
6) 향후 Scoring에 링커/페이로드가 들어가려면 **식별자/버전/속성(분류/절단기전 등)** 최소 스키마가 필요

---

## 1. 데이터 모델 설계 (DB)

### 1.1 신규: entity_linkers (링커 엔티티)
**역할:** 링커를 “표준 카탈로그 엔티티”로 관리하고, Seed Set에서 선택 가능한 항목 제공  
**중요:** 초기 MVP에서는 구조식(SMILES) 필수 아님. 분류/기전/안정성 힌트 중심으로 시작.

권장 컬럼(최소/권장):
- `id` (uuid, PK)
- `name` (text, unique) — 예: “Val-Cit”, “SMCC”, “mc-vc-PABC” 등
- `linker_type` (text) — `cleavable` / `non_cleavable`
- `cleavage_mechanism` (text, nullable) — 예: `cathepsin`, `reducible_disulfide`
- `stability_hint` (text, nullable) — 예: “plasma_stable”, “moderate”
- `bystander_hint` (text, nullable) — 링커 특성상 bystander 가능성에 영향이 있다면 힌트
- `source_ref` (text, nullable) — DOI/PMID/URL
- `notes` (text, nullable)
- `created_at`, `updated_at`

**인덱스/제약:**
- unique(name)
- index(linker_type)

---

### 1.2 신규: seed_set_linkers (Seed Set ↔ 링커 M:N)
**역할:** 특정 Seed Set이 사용할 링커 후보군을 정의  
- `seed_set_id` (uuid, FK)
- `linker_id` (uuid, FK)
- PK: `(seed_set_id, linker_id)`
- index(seed_set_id), index(linker_id)

---

### 1.3 페이로드: 기존 entity_drugs 활용 + “payload 구분”
제안대로 `entity_drugs`를 재사용하는 것은 좋습니다. 단, 운영을 위해 아래 중 하나가 필요합니다.

**옵션 A(권장): entity_drugs에 구분 컬럼 추가**
- `drug_role` (text) — 예: `payload`, `small_molecule`, `biologic`, `other`
- payload만 Seed Set에서 필터링

**옵션 B: seed_set_payloads 관계 테이블만 두고 UI에서 선별**
- 단점: entity_drugs 데이터가 커지면 payload 필터링이 어려움(운영 리스크)

---

### 1.4 신규(권장): seed_set_payloads (Seed Set ↔ payload(drug) M:N)
Seed Set이 사용할 payload 후보군을 정의(링커와 동일 패턴).

- `seed_set_id` (uuid, FK)
- `drug_id` (uuid, FK to entity_drugs)
- PK: `(seed_set_id, drug_id)`

---

### 1.5 RLS / 권한 정책(필수 보완)
**정책 목표:**
- 일반 사용자: Seed Set “조회/자기 워크스페이스 사용”까지만
- Admin: 카탈로그(링커/드럭/시드 관계) 수정 가능

권장 구현(개요):
- `entity_linkers`, `entity_drugs`는 admin만 insert/update/delete
- `seed_sets` 및 관계 테이블은 admin만 관리(또는 workspace 기반으로 확장 계획이 있다면 별도 정책)

---

## 2. 마이그레이션 파일 구체화

### 2.1 [NEW] 20260111133000_add_linkers_table.sql
아래 형태로 구체화 권장(예시):

```sql
-- 20260111133000_add_linkers_table.sql

-- 1) linkers entity
create table if not exists public.entity_linkers (
  id uuid primary key default gen_random_uuid(),
  name text not null,
  linker_type text not null check (linker_type in ('cleavable','non_cleavable')),
  cleavage_mechanism text,
  stability_hint text,
  bystander_hint text,
  source_ref text,
  notes text,
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);

create unique index if not exists uq_entity_linkers_name on public.entity_linkers (name);
create index if not exists idx_entity_linkers_type on public.entity_linkers (linker_type);

-- 2) seed set linkers relation
create table if not exists public.seed_set_linkers (
  seed_set_id uuid not null references public.seed_sets(id) on delete cascade,
  linker_id uuid not null references public.entity_linkers(id) on delete restrict,
  created_at timestamptz not null default now(),
  primary key (seed_set_id, linker_id)
);

create index if not exists idx_seed_set_linkers_seed on public.seed_set_linkers (seed_set_id);
create index if not exists idx_seed_set_linkers_linker on public.seed_set_linkers (linker_id);

-- 3) payload role on entity_drugs (옵션A 권장)
alter table public.entity_drugs
  add column if not exists drug_role text;

create index if not exists idx_entity_drugs_role on public.entity_drugs (drug_role);

-- 4) seed set payloads relation (권장)
create table if not exists public.seed_set_payloads (
  seed_set_id uuid not null references public.seed_sets(id) on delete cascade,
  drug_id uuid not null references public.entity_drugs(id) on delete restrict,
  created_at timestamptz not null default now(),
  primary key (seed_set_id, drug_id)
);

create index if not exists idx_seed_set_payloads_seed on public.seed_set_payloads (seed_set_id);
create index if not exists idx_seed_set_payloads_drug on public.seed_set_payloads (drug_id);

-- 5) updated_at 트리거가 기존에 있다면 연결(프로젝트 표준에 맞춤)
보완 포인트

on delete restrict를 linker/drug FK에 두는 이유: 카탈로그 엔티티를 삭제할 때 기존 시드가 깨지는 사고를 방지

실제 프로젝트에 seed_sets 테이블 명이 다르면 맞춰 수정

3. 서버 액션(admin.ts) 보완 설계
3.1 읽기 액션(필수)
getSeedLinkers(seed_set_id)

return: 해당 seed_set에 연결된 linkers 목록

getSeedPayloads(seed_set_id)

return: seed_set에 연결된 payload(drug_role='payload') 목록

추가로 아래 2개가 실무상 필요합니다(성능/UX):

searchLinkers(query, limit)

searchPayloads(query, limit) — payload만 필터링

3.2 생성/수정 액션(필수)
createSeedSet 로직 확장
입력 DTO(권장):

기본: name, description, target_ids[], disease_ids[]

추가: linker_ids[], payload_drug_ids[]

트랜잭션 권장 순서:

seed_sets insert

seed_set_targets bulk insert

seed_set_diseases bulk insert

seed_set_linkers bulk insert

seed_set_payloads bulk insert
→ 하나라도 실패하면 rollback

에러 처리(필수):

FK 존재 검증(선택된 linker/drug가 실제 존재하는지)

payload는 drug_role='payload'인지 검사(옵션A 적용 시)

3.3 안정화: createConnector / triggerConnectorRun
이번 Phase에서 커넥터 UI를 만지므로, backend 액션도 최소 안정화 필요:

입력값 validation(필수 필드 누락/URL 형식/타임아웃)

triggerConnectorRun 실행 시:

실행 레코드 생성(예: connector_runs)

상태: queued → running → success/failed

실패 시 error_message 저장

“데이터 정합성 검증”을 하려면 실행 기록 테이블이 있어야 합니다.

4. 프론트엔드(UI) 구체화
4.1 seeds/page.tsx: 탭 확장(링커/페이로드)
UI 구조 권장
상단: Seed Set 리스트 / 상세

상세 탭:

Targets

Diseases

Linkers (NEW)

Payloads (NEW)

각 탭 공통 컴포넌트 패턴(권장):

검색 입력(Search)

결과 리스트(선택 버튼)

선택된 항목 배지(Badge) + X로 삭제

다중 선택 상태 유지

생성 모달 확장
모달 섹션을 4블록으로 구성:

Seed 기본 정보

Targets 선택(기존)

Diseases 선택(기존)

Linkers 선택(신규)

Payloads 선택(신규)

UX 보완(필수)

검색 debounce(300ms)

선택한 항목은 검색 결과에서 “선택됨” 표시 및 재선택 방지

20개 이상 선택 시 스크롤 영역 분리(모달 높이 고정)

“Clear all” 버튼 제공(대량 삭제 편의)

4.2 connectors/page.tsx: 실행 버튼 연동 강화
보완 항목(구체화)

커넥터 카드에 “상태 pill” 표시: idle/queued/running/success/failed

실행 버튼 클릭 시:

즉시 UI 상태 queued로 전환(낙관적 업데이트)

서버 응답 실패 시 롤백 + toast 에러

생성 모달 validation:

name 필수

type 선택(예: pubmed/uniprot/adcdatabase 등)

params JSON 유효성 검사(잘못된 JSON 방지)

4.3 [NEW] scoring/page.tsx (추후 구현)
이번 Phase에서는 “페이지/라우트만 생성 + 스켈레톤”으로 두되,
향후 연결을 위해 아래 메타를 미리 정리해 두는 것을 권장합니다.

scoring_version 목록/활성 버전

축별 가중치/컷오프

Golden validation 결과 링크

5. Seed 데이터(초기 시딩) 보완(권장)
링커/페이로드 테이블만 만들어도 비어 있으면 여전히 조합 설계가 어렵습니다.
따라서 Phase 17에 최소 Seed를 포함시키는 것을 권장합니다.

5.1 최소 링커 Seed(예시)
cleavable: Val-Cit, Val-Ala, peptide(PABC 계열)

non-cleavable: SMCC, thioether 계열

5.2 최소 payload Seed(예시)
entity_drugs에 아래처럼 “payload”로 등록(옵션A):

MMAE(auristatin), MMAF(auristatin)

DM1(maytansinoid), DM4(maytansinoid)

DXd(topoisomerase I inhibitor) 등
※ 정확한 화학 정보는 2단계 고도화에서 보강

6. 검증 계획 보완(테스트 항목을 “정량”으로)
6.1 수동 검증(Seed Set)
체크리스트(필수):

 각 탭(타겟/질환/링커/페이로드) 검색이 정상 동작

 다중 선택 후 배지 표시

 배지 삭제 시 상태가 즉시 반영

 생성 모달에서 4종 요소 선택 후 생성 성공

 생성 후 상세 탭에서 관계 테이블 값이 정확히 조회됨

 payload 탭은 drug_role='payload'만 노출(옵션A 적용 시)

6.2 수동 검증(커넥터)
 기본 커넥터 노출

 데이터 수집 클릭 → 상태가 queued/running 으로 변화

 실패 시 failed + 에러 메시지 노출

 신규 커넥터 생성 시 validation 정상 작동(잘못된 입력 차단)

6.3 데이터 정합성(핵심)
 커넥터 실행 후 connector_runs(또는 equivalent) 상태 업데이트 확인

 문헌 적재 테이블(literature_documents 등)에 레코드 생성 확인

 해당 레코드가 seed_set_id/run_id 등 컨텍스트 키와 연결되는지 확인(없다면 추가 필요)

7. 운영 리스크 및 보완(필수 고려)
7.1 데이터 혼입 방지
entity_drugs 전체가 payload로 노출되면 데이터 혼입 발생
→ drug_role='payload' 필터 강제(권장)

7.2 삭제 정책
링커/페이로드 엔티티 삭제는 Seed Set을 깨뜨릴 수 있음
→ FK restrict + “비활성화(is_active)” 컬럼 방식 권장

7.3 버전 관리
Seed Set은 시간이 지나면 구성요소가 바뀜
→ seed_set_versions까지는 Phase 17에서 과하지만,
최소한 seed_set 수정 시 변경 로그를 남길 수 있는 audit 테이블을 고려(옵션)

8. 변경 파일별 작업 정의(명확화)
[Database] NEW
20260111133000_add_linkers_table.sql

entity_linkers

seed_set_linkers

(권장) seed_set_payloads

(권장) entity_drugs.drug_role

인덱스/제약/RLS

[Frontend] MODIFY
seeds/page.tsx

탭: Targets / Diseases / Linkers / Payloads

모달: 4종 선택 + 검색 + 배지 + 삭제

공통 멀티셀렉트 컴포넌트화(중복 제거 권장)

connectors/page.tsx

상태 표시, 실행 버튼 낙관적 업데이트

생성 모달 validation/에러 처리

[Backend] MODIFY
admin.ts

getSeedLinkers, getSeedPayloads

searchLinkers, searchPayloads(권장)

createSeedSet에 linker_ids/payload_ids 연동

createConnector/triggerConnectorRun 안정화

[Frontend] NEW
scoring/page.tsx

스켈레톤 페이지 + “추후 구현” 명시(라우트만 안정적으로)

9. 완료 기준(Definition of Done)
Phase 17 완료를 아래 조건으로 정의합니다.

Seed Set 생성 시 타겟/질환/링커/페이로드를 모두 선택해 저장할 수 있다.

Seed Set 상세에서 4종 요소가 정확히 조회되고 편집(추가/삭제) 가능하다.

payload는 payload만 노출되는 정책이 적용되어 있다.

커넥터 실행 상태가 UI에 반영되며, 실패 이유를 확인할 수 있다.

커넥터 실행 후 관련 테이블에 데이터가 적재됨을 최소 1개 시나리오로 검증했다.

10. 다음 단계(Phase 18 제안, 참고)
Phase 17이 완료되면 “조합 설계”를 실제로 작동시키기 위한 최소 다음 단계는 아래입니다.

Seed Set 기반 “조합 후보 생성” 로직(링커×페이로드×타겟×항체의 후보 공간 생성)

scoring/page.tsx에서 scoring_version 및 축별 파라미터를 관리

Golden Set 검증 리포트 UI 노출(회귀 테스트 자동화)