# ADC Platform — Golden Set(Seed 20) 기반 Enrichment 자동화 (AntiGravity 작업지시서)
버전: v1.0  
작성일: 2026-01-14  
목표: **이미 DB에 입력된 Golden Set 20개(Seed)**를 기준으로 Big 3 API에서 **필요 필드만 자동 보강(Enrichment)**하여  
(1) 임상 상태/근거, (2) Payload 구조(SMILES), (3) RDKit 특성치를 채우고,  
자동 매칭이 불확실한 건 **Admin Review Queue**로 보내 품질을 유지한다.

---

## 0) 핵심 원칙 (반드시 준수)
1. **Seed-driven**: 수집은 “새 후보 발굴”이 아니라 **Seed 20개 레코드의 필드로 쿼리를 만들고 부족 필드를 채우는 것**.
2. **보수적 자동화**: ClinicalTrials 매칭은 오탐 위험이 크므로 **자동 확정 금지**(확정은 Admin).
3. **RAW 저장 + Lineage**: API 응답 원문(JSON)은 반드시 RAW 테이블에 저장(재현성과 디버깅).
4. **LLM은 보조**: LLM은 “중단 사유 텍스트 분류/요약” 정도만(검색/정답 생성 금지).

---

## 1) 현재 Seed 20개(이미 입력됨) 기준 필드 정의
Seed 테이블(가칭: `golden_set_items` 또는 `golden_candidates`)에 최소 아래 컬럼이 존재한다고 가정한다.

- drug_name_canonical (TEXT)  ✅ 필수
- aliases (TEXT, pipe `|` 구분)  ✅ 권장
- target (TEXT) ✅ 필수
- antibody (TEXT) ✅ 권장
- linker_family (TEXT) ✅ 권장
- linker_trigger (TEXT) ✅ 권장
- payload_family (TEXT) ✅ 권장
- payload_exact_name (TEXT) ✅ 필수(가능하면)
- proxy_smiles_flag (BOOL) ✅ 권장
- proxy_reference (TEXT) ✅ proxy 시 필수
- clinical_phase (TEXT) ✅ 권장
- program_status (TEXT) ✅ 권장
- outcome_label (TEXT) ✅ 권장
- primary_source_type (TEXT) ✅ 권장
- primary_source_id (TEXT) ✅ 권장 (NCT 또는 BLA/PMID 등)

---

## 2) DB 스키마 업데이트 (최소 변경 권장)
### 2.1 Seed 테이블에 추가할 컬럼 (권장)
> 기존 테이블명 유지. 컬럼만 추가.

- resolved_target (TEXT) : target 표준화 결과 (예: HER2 → ERBB2, FR alpha → FOLR1, Tissue Factor → F3)
- clinical_nct_id (TEXT) : 확정된 NCT ID
- nct_match_confidence (FLOAT) : 자동 매칭 점수(0~1)
- nct_match_candidates (JSONB) : 후보 NCT 리스트 및 점수
- payload_smiles (TEXT) : 최종 SMILES
- payload_inchi_key (TEXT) : 중복/정규화 키
- payload_cid (TEXT) : PubChem CID
- enrichment_status (TEXT) : pending/running/partial/done/fail
- updated_at (TIMESTAMP)

### 2.2 RAW 저장 테이블 (필수)
#### (A) clinical RAW
`golden_enrich_raw_clinical`
- id (UUID)
- seed_id (UUID FK)
- source = 'clinicaltrials'
- request_json (JSONB)
- response_json (JSONB)
- source_id (TEXT) : NCT ID
- source_hash (TEXT) : 응답 해시(중복 방지)
- fetched_at (TIMESTAMP)
- parser_version (TEXT)

#### (B) pubchem RAW
`golden_enrich_raw_pubchem`
- id (UUID)
- seed_id (UUID FK)
- source = 'pubchem'
- query_text (TEXT)
- response_json (JSONB)
- cid (TEXT)
- fetched_at (TIMESTAMP)
- parser_version (TEXT)

### 2.3 Admin Review Queue (필수)
`golden_review_queue`
- id (UUID)
- seed_id (UUID FK)
- queue_type (TEXT) : nct_ambiguous | nct_missing | payload_smiles_missing | target_unresolved | other
- severity (TEXT) : high | medium | low
- payload (JSONB) : 후보/근거/오류 메시지
- status (TEXT) : open | resolved | dismissed
- created_at (TIMESTAMP)
- updated_at (TIMESTAMP)

### 2.4 RDKit Feature 테이블 (권장)
`payload_features`
- id (UUID)
- seed_id (UUID FK)
- smiles (TEXT)
- inchi_key (TEXT)
- mw (FLOAT), logp (FLOAT), tpsa (FLOAT)
- hbd (INT), hba (INT), rotatable_bonds (INT)
- fraction_csp3 (FLOAT), num_rings (INT), formal_charge (INT)
- qed_score (FLOAT)
- sa_score (FLOAT)  (가능하면)
- pains_flag (BOOL) (가능하면)
- computed_at (TIMESTAMP)
- rdkit_version (TEXT)

---

## 3) 워커/잡 설계 (Seed-driven Enrichment 3종)
### 공통 입력/출력 규칙
- 입력: Seed 레코드 리스트 (기본: Seed 20 전부 또는 seed_id 1개)
- 출력: Seed 테이블 업데이트 + RAW 저장 + Review Queue 생성
- 실패 처리: 치명 오류가 아니면 **partial로 진행**, 누락만 Review Queue로

---

## 4) Job A — ClinicalTrials Enrichment (NCT 매칭 + 임상 상태)
### 4.1 파일/엔트리
- `services/worker/jobs/golden_enrich_clinical_job.py`
- 함수: `execute_golden_enrich_clinical(ctx, run_id: str, config: dict)`

### 4.2 쿼리 입력 생성 (Seed 기반)
우선순위:
1) `primary_source_id`가 `NCT\d+` 형식이면 **direct fetch**
2) 아니면 `drug_name_canonical` + `aliases` + `resolved_target(or target)` 기반 검색

검색 쿼리 구성 가이드:
- terms = [
  drug_name_canonical,
  aliases split('|'),
  resolved_target or target,
  "antibody-drug conjugate",
  "immunoconjugate",
  "antibody conjugate",
  "ADC"
]
- BUT: 광범위 OR로 검색하되, **후보는 점수화**하고 자동 확정하지 않는다.

### 4.3 후보 NCT 점수화 규칙 (오탐 방지용)
`match_score = 0~1`로 산출하고 후보 리스트 생성:
- drug_name_canonical이 title/intervention에 포함: +0.45
- aliases 중 하나 포함: +0.25
- target(또는 resolved_target)이 conditions/keywords에 포함: +0.15
- ADC 키워드(antibody-drug conjugate 등) 포함: +0.10
- oncology/solid/hematologic 용어 포함: +0.05

결정 규칙:
- score >= 0.85 AND 후보 1개만 유의미: `clinical_nct_id` 자동 세팅(단, Admin 확인 필요 표시)
- score < 0.85 또는 후보 복수: `golden_review_queue(queue_type='nct_ambiguous')` 생성

### 4.4 업데이트 필드
- clinical_nct_id (확정 시)
- nct_match_confidence
- nct_match_candidates (후보 리스트 JSON)
- program_status / clinical_phase (가능하면 최신으로 동기화)
- conditions (있다면 별도 컬럼 또는 jsonb로 저장)
- why_stopped (Terminated면 저장; 텍스트 길면 jsonb)

### 4.5 RAW 저장
- 요청/응답을 `golden_enrich_raw_clinical`에 저장(항상)

---

## 5) Job B — PubChem Enrichment (Payload SMILES 확보)
### 5.1 파일/엔트리
- `services/worker/jobs/golden_enrich_pubchem_job.py`
- 함수: `execute_golden_enrich_pubchem(ctx, run_id: str, config: dict)`

### 5.2 쿼리 입력 (Seed 기반)
- query_text = payload_exact_name
- 실패 시:
  - if proxy_smiles_flag == true and proxy_reference 존재: query_text = proxy_reference
  - else: Review Queue 생성

### 5.3 처리 로직
1) PubChem REST로 CID 검색 (name → CID)
2) CID로 IsomericSMILES / CanonicalSMILES 가져오기
3) smiles 정규화(가능하면) 후 `payload_smiles`, `payload_cid`, `payload_inchi_key` 저장

### 5.4 실패/리뷰 큐
- `payload_smiles_missing` 생성
  - payload_exact_name
  - 시도한 query_text
  - 실패 사유(404/empty/timeout)

### 5.5 RAW 저장
- `golden_enrich_raw_pubchem`에 query/response 저장(항상)

---

## 6) Job C — RDKit Features 계산
### 6.1 파일/엔트리
- `services/worker/jobs/rdkit_features_job.py`
- 함수: `execute_rdkit_features(ctx, run_id: str, config: dict)`

### 6.2 입력
- Seed 중 `payload_smiles` 존재하는 항목만 대상

### 6.3 산출 및 저장
- payload_features에 upsert
- 기준 계산:
  - MW, LogP, TPSA, HBD/HBA, RotB, Rings, FormalCharge, FractionCSP3, QED
  - SA score / PAINS는 가능하면(라이브러리 준비 필요 시 Phase 2)

### 6.4 품질 플래그(리포트/게이트용)
- aggregation_risk = (logP > 4.0 AND fraction_csp3 < 0.3)
- permeability_ok = (MW < 1000 AND TPSA < 140)
- synth_easy = (sa_score < 4.0) (가능하면)

---

## 7) Admin UI — Review & Promote (필수 최소 기능)
### 7.1 화면 1: Review Queue 리스트
- 필터: queue_type, severity, status(open/resolved)
- 테이블: drug_name_canonical, target, queue_type, created_at, action(보기)

### 7.2 화면 2: NCT 후보 확정 모달
- 후보 NCT 리스트(점수 포함) 표시
- 클릭 확정 → Seed의 clinical_nct_id 업데이트, queue status=resolved
- “없음” 처리 → dismissed

### 7.3 화면 3: Payload SMILES 수기 입력
- payload_exact_name, proxy_reference 표시
- smiles 입력/검증(간단히 RDKit parse로 유효성 체크)
- 저장 → Seed.payload_smiles 업데이트, queue resolved

---

## 8) 실행 플로우 (운영 순서)
1) `resolve_ids_job` (target 표준화) — optional but strongly recommended  
2) `golden_enrich_clinical_job` (NCT 매칭 후보 생성 + 상태 업데이트)  
3) Admin에서 NCT 확정(Review Queue 처리)  
4) `golden_enrich_pubchem_job` (payload SMILES 자동 채우기)  
5) Admin에서 SMILES 누락 항목 수기 보정  
6) `rdkit_features_job` (RDKit 일괄 계산)

---

## 9) Config / Runtime
### 9.1 Job config 예시
- golden_enrich_clinical_job
  - seed_ids: [] (없으면 전체)
  - max_candidates_per_seed: 10
  - min_auto_confirm_score: 0.85
  - parser_version: "clinical-v1.0"

- golden_enrich_pubchem_job
  - seed_ids: []
  - use_proxy_reference: true
  - parser_version: "pubchem-v1.0"

- rdkit_features_job
  - seed_ids: []
  - rdkit_version: "2025.x"

### 9.2 로컬 도커/백엔드 환경 주의
- Next.js에서 `127.0.0.1:8000` ECONNREFUSED가 발생하면:
  - 백엔드 컨테이너가 내려갔거나 포트 매핑/네트워크가 끊긴 상태
- 원칙:
  - Front 컨테이너에서 “127.0.0.1”은 **Front 컨테이너 자신**이므로, 백엔드 서비스명으로 접근해야 함
  - 예: `http://backend:8000` (docker-compose service name)

권장: `.env.local`
- API_BASE_URL=http://backend:8000
- SUPABASE_URL=...
- SUPABASE_SERVICE_ROLE_KEY=...

---

## 10) Acceptance Criteria (완료 기준)
1) Seed 20개 중 최소 15개 이상에서 ClinicalTrials 후보 리스트가 생성된다.
2) 후보 NCT를 Admin이 확정하면 clinical_nct_id가 저장되고 RAW가 남는다.
3) Seed 20개 중 최소 12개 이상에서 payload_smiles가 자동 채워진다(나머지는 Review Queue).
4) payload_smiles가 있는 항목은 RDKit feature가 모두 계산되어 payload_features에 저장된다.
5) Review Queue가 “누락/애매함”을 정확히 모아주며, Admin이 이를 해결하면 큐가 resolved 된다.

---

## 11) 구현 파일 목록 (추가/수정)
- [NEW] services/worker/jobs/golden_enrich_clinical_job.py
- [NEW] services/worker/jobs/golden_enrich_pubchem_job.py
- [NEW/EXIST] services/worker/jobs/rdkit_features_job.py
- [EXIST] services/worker/jobs/resolve_ids_job.py (target 표준화 강화)
- [MOD] services/worker/jobs/connector_executor.py (job 등록/라우팅)
- [MOD] services/worker/jobs/worker.py (job registry 추가)
- [NEW] SQL migration: raw tables + review queue + payload_features + seed 컬럼 추가

---

## 12) 다음 단계(Phase 2) — Chem-OCR/Patent 구조 (장기)
- Google Patents/PDF에서 payload/linker 구조를 자동 추출하는 Chem-OCR 도입
- 단, MVP에서는 품질 위해 “수기 + proxy SMILES” 우선 전략 유지
