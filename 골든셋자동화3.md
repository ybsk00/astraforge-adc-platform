# [ADC Platform] Golden Set 구축/자동화 MVP (Antigravity 실행용) — Final Spec
버전: v1.0 (2026-01-14)
목적: **수동 Seed 20개(이미 입력됨)**를 기준으로, Big-3(ClinicalTrials/PubChem/ChEMBL) + RDKit + RAG를 활용해 **근거 기반 Enrichment → Review Queue → Admin 승격(Final)** 워크플로우를 구현한다.  
핵심 원칙: **자동 덮어쓰기 금지(Verified 보호)**, **Proxy는 자동 반영 금지(Review Queue 전용)**, **모든 변경은 Evidence/Lineage로 추적**.

---

## 0) MVP 범위 및 정책
### 0.1 MVP 범위(이번 Sprint)
- 수동 Seed(20개) 테이블/화면/승격 프로세스 구축
- Enrichment Job 3종(ClinicalTrials / PubChem / RDKit) 구현
- ID Resolver(동의어 사전) + Unmapped Queue + Admin Override 구현
- Review Queue + Diff View(승인/반려/수정) 구현
- Final 승격 테이블/화면 구현
- RAG/LLM은 **“추론 결과를 Review Queue로만 제안”**(자동 반영 금지)

### 0.2 승격 정책(Option C 채택: NCT 필수 아님)
- **clinical_nct_id_primary는 승격 필수 조건이 아니다.**
- 승격 필수 Gate는 아래 3개:
  1) resolved_target_symbol 존재
  2) payload_smiles_standardized 존재 OR proxy_smiles_flag=true
  3) evidence_refs 최소 1개 이상(권장 2개 이상)
- 단, NCT는 있으면 **Enrichment 앵커로 활용**(품질 가점/추적 강화)

### 0.3 “Admin 확정 데이터 보호(Overwrite Protection)” 필수
- Admin이 검증한 필드는 워커가 절대 덮어쓰지 않는다.
- 자동 업데이트가 필요하면 **Review Queue에 “제안”으로만 적재**한다.

---

## 1) 데이터 모델(필수 테이블/컬럼)
> 기존 golden_candidates(자동 수집)와 **분리 운영**한다.  
> `/admin/golden-sets`에서 탭으로 분리: **Auto vs Manual**

### 1.1 Manual Seed: `golden_seed_items` (핵심)
- 목적: Admin이 관리하는 “정답지 후보”의 원장(Seed + Enrichment 저장)
- 주요 컬럼(권장):
  - id (uuid, pk)
  - portfolio_group (text)  // Group A/B/C/D
  - drug_name_canonical (text)
  - aliases (text)  // "Enhertu|DS-8201"
  - target (text)
  - resolved_target_symbol (text)  // 예: HER2 → ERBB2
  - antibody (text)
  - linker_family (text)
  - linker_trigger (text)
  - payload_family (text)
  - payload_exact_name (text)
  - payload_smiles_raw (text)  // PubChem 원문 또는 수기 입력 원문
  - payload_smiles_standardized (text) // RDKit 표준화 후
  - inchi_key (text)
  - proxy_smiles_flag (bool, default false)
  - proxy_reference (text)  // 예: "Belotecan core"
  - is_proxy_derived (bool, default false) // RDKit feature가 Proxy 기반이면 true
  - clinical_phase (text)  // Approved / Phase 3 ...
  - program_status (text)  // Active / Terminated ...
  - outcome_label (text)  // Success/Fail/Uncertain/Caution
  - key_risk_category (text)
  - key_risk_signal (text)
  - failure_mode (text)
  - evidence_refs (jsonb)  // [{type:'BLA',id:'...'}, {type:'PMID',id:'...'}, {type:'NCT',id:'...'}]
  - clinical_nct_id_primary (text, nullable) // 옵션
  - dataset_version (text)  // "manual-20260114"
  - lineage (jsonb)  // 어떤 job이 어떤 값을 채웠는지
  - run_inputs_hash (text) // 재현성
  - created_at, updated_at

#### 1.1.1 필드별 검증 플래그(Overwrite Protection)
- 전체를 막는 `is_manually_verified`도 가능하지만, MVP에서는 **필드별**을 권장:
  - verified_json (jsonb)
    - 예: {"payload_smiles_standardized": true, "resolved_target_symbol": true, "clinical_phase": true}
- 워커 규칙:
  - 특정 필드가 verified=true면 **자동 update 금지**
  - 변경 제안은 review_queue에만 적재

---

### 1.2 ID Resolver 동의어 사전: `synonym_dictionary` (필수)
- 목적: resolve_ids_job의 핵심 기반(표적/항체/링커/페이로드 모두 확장 가능)
- 컬럼:
  - id (uuid)
  - entity_type (text) // target/payload/linker/antibody
  - alias_text (text) // "Her2", "neu", "CD340"
  - canonical_key (text) // "ERBB2"
  - source (text) // "hgnc" | "admin" | "import"
  - confidence (float) // admin override는 1.0
  - created_at, updated_at
- 인덱스:
  - unique(entity_type, lower(alias_text))

---

### 1.3 Unmapped Queue: `unmapped_queue` (필수)
- 목적: Resolver 실패 항목을 Admin이 처리하여 사전에 누적
- 컬럼:
  - id (uuid)
  - entity_type (text)
  - unmapped_text (text)
  - context (jsonb) // 어떤 seed_item, 어떤 source에서 왔는지
  - status (text) // open/resolved/ignored
  - resolved_canonical_key (text, nullable)
  - resolved_by (text, nullable)
  - created_at, updated_at

---

### 1.4 Review Queue: `golden_review_queue` (필수, Diff View 전제)
- 목적: 워커/LLM이 제안한 변경을 Admin이 승인/반려/수정
- 컬럼:
  - id (uuid)
  - seed_item_id (uuid, fk golden_seed_items)
  - queue_type (text) // enrichment_update | proxy_suggestion | resolver_suggestion | conflict_detected
  - entity_type (text) // seed_item
  - proposed_patch (jsonb) // 필드별 old/new/evidence를 포함한 “Diff-ready 구조”
  - evidence_refs (jsonb)
  - confidence (float) // 0~1
  - status (text) // pending/approved/rejected/applied
  - created_at, updated_at
- 핵심 규칙:
  - **JSON 덩어리 금지**: proposed_patch는 반드시 `field -> {old,new,source,evidence}` 구조
  - 예:
    - {
        "payload_smiles_standardized": {
          "old": "",
          "new": "C1=CC...",
          "source": "pubchem",
          "evidence": [{"type":"PubChemCID","id":"12345"}]
        }
      }

---

### 1.5 RDKit 결과: `payload_features` (필수)
- 목적: 보고서/추천 점수 산출의 기반 데이터(Proxy 여부 명시)
- 컬럼(최소):
  - id (uuid)
  - seed_item_id (uuid, fk)
  - smiles_used (text) // 표준화된 SMILES(계산에 실제 사용)
  - is_proxy_derived (bool)
  - mw, logp, tpsa, hbd, hba, rotatable_bonds
  - fraction_csp3, num_rings, formal_charge
  - qed_score, sa_score, pains_flag
  - salt_removed (bool) // SaltRemover 적용 여부
  - rdkit_version (text)
  - created_at, updated_at

---

### 1.6 Final 승격 테이블: `golden_set_final` (권장)
- 목적: “승격된 정답지”만 별도 관리(학습/검증/추천의 기준)
- 컬럼:
  - id (uuid)
  - seed_item_id (uuid, fk)
  - promoted_at
  - promoted_by
  - gate_snapshot (jsonb) // 승격 시점의 Gate 충족 증거
  - notes (text)

---

## 2) 워커/잡 설계(Big-3 + RDKit + Resolver + RAG/LLM)
### 2.1 Job 의존성(필수 순서)
1) resolve_ids_job (Required)
2) pubchem_enrich_job (SMILES/구조)
3) clinicaltrials_enrich_job (임상 상태/대표 NCT는 옵션)
4) rdkit_features_job (표준화 + 계산)
5) (Optional) rag_evidence_job / llm_proxy_suggest_job → **Review Queue only**
6) quality_gate_job (Gate 체크 + 승격 후보 표시)

---

## 3) 각 Job 상세 스펙

### 3.1 resolve_ids_job (필수)
목표: `target` 텍스트 → `resolved_target_symbol` 채움  
입력: golden_seed_items 중 resolved_target_symbol 비어있거나 verified=false인 항목  
로직(우선순위):
1) synonym_dictionary (admin source 우선) exact match (lower)
2) synonym_dictionary (hgnc/import)
3) (선택) fuzzy 후보 제안(자동 확정 금지) → unmapped_queue 등록
출력:
- 성공: golden_seed_items.resolved_target_symbol 업데이트(verified=false이면만)
- 실패: unmapped_queue(open) 적재

초기 데이터:
- HGNC dump를 seed로 synonym_dictionary에 적재(타겟용)

Acceptance Criteria:
- HER2/neu/CD340 입력 → ERBB2로 resolve
- TROP2 → TACSTD2 resolve
- Resolver 실패 시 unmapped_queue에 쌓이고 Admin이 지정하면 즉시 사전에 누적

---

### 3.2 pubchem_enrich_job (SMILES Ready)
목표: payload_exact_name 기반으로 PubChem에서 구조 획득, 표준화/Proxy 처리
입력: golden_seed_items 중 (payload_smiles_standardized 비어있고 proxy_smiles_flag=false) AND verified_smiles=false
로직:
1) PubChem 검색(우선순위):
   - payload_exact_name
   - aliases 분해 후 후보 키워드
   - payload_family + payload_exact_name 조합(보조)
2) 결과 후보가 여러 개면:
   - CID 상위 N개(예: 5) 수집 후 Review Queue 제안(자동 확정 금지) OR
   - 규칙 기반(정확명 일치, isomericSMILES 존재) 1개면 자동 적용
3) SMILES 표준화:
   - RDKit Standardizer + **SaltRemover 필수**
   - 표준화 결과: payload_smiles_standardized
   - inchi_key 생성
4) 실패 시:
   - Review Queue에 “Proxy 필요”로 등록 (queue_type=proxy_suggestion)
   - proxy_reference 후보(CID/대표 core 등)를 함께 제안(가능하면)
5) Verified 보호:
   - verified_json.payload_smiles_standardized=true이면 **자동 업데이트 금지**
   - 대신 review_queue에 제안만 적재

Acceptance Criteria:
- DXd/DM1/MMAE/SN-38/Eribulin 등은 PubChem로 채워짐
- 복잡 구조(예: PBD dimer 등) 실패 시 “Proxy suggestion”으로 review_queue 적재

---

### 3.3 clinicaltrials_enrich_job (옵션 강화)
목표: 임상 상태/phase/status 업데이트 및 evidence_refs 보강  
입력: golden_seed_items (clinical_phase/program_status/evidence 부족) AND 해당 필드 verified=false  
검색 쿼리 정책(노이즈 최소):
- “암종 기반”이 아니라 **표적 기반 + ADC 문맥**으로 수집 (현 운영 합의)
- Query Template:
  - (resolved_target_symbol OR target) AND ("antibody-drug conjugate" OR "antibody drug conjugate" OR ADC OR immunoconjugate OR "antibody conjugate")
  - 필요 시 키워드에 “solid tumor”, “oncology” 등 추가하되 OR 남용 주의
대표 임상 선정(Hierarchy):
- Phase 3 > Phase 2 > Phase 1 가점
- Status: Active/Recruiting/Completed 가점
- Terminated면 reason(가능하면) 추출하여 evidence로 적재
주의:
- Option C로 승격 필수는 아니지만, 있으면 추적성/신뢰도 상승

Acceptance Criteria:
- 매 seed_item마다 evidence_refs에 NCT를 “추가 제안”할 수 있음(자동 적용/검증 정책 선택)

---

### 3.4 rdkit_features_job (계산)
목표: 표준화된 SMILES 기반 RDKit 지표 산출 및 저장  
입력: payload_smiles_standardized 존재 OR proxy_smiles_flag=true  
로직:
1) 계산 대상 SMILES 결정:
   - payload_smiles_standardized 있으면 사용
   - 없고 proxy_smiles_flag=true면 proxy_reference 기반 SMILES를 사용(있어야 함)
2) 전처리:
   - **SaltRemover 적용 필수(salt_removed=true)**
   - 실패 시 review_queue에 적재(구조 오류)
3) 지표 계산:
   - mw, logp, tpsa, hbd, hba, rotatable_bonds
   - fraction_csp3, num_rings, formal_charge
   - qed_score, sa_score, pains_flag
4) Proxy 명시:
   - is_proxy_derived = proxy_smiles_flag
5) 저장:
   - payload_features upsert(seed_item_id)

Acceptance Criteria:
- 20개 모두 payload_features가 생성되거나, 실패 시 review_queue에 명확한 오류가 등록됨
- Proxy 기반은 is_proxy_derived=true로 표시됨

---

### 3.5 rag_evidence_job / llm_proxy_suggest_job (Review Queue only)
목표: 부족한 근거/Proxy 후보를 **근거 기반으로 제안**하되 자동 반영 금지  
원칙:
- LLM은 “검색”이 아니라 “정제/평가/분류”에만 사용
- PubChem 후보(CID 리스트 등)는 시스템이 먼저 만들고, LLM은 **타당성 평가**만 수행
Good Prompt Template(Proxy 평가):
- 입력: payload_family, payload_exact_name, 후보 CID 리스트(0~5), 근거 링크/요약
- 출력: 추천 CID 1개 + 근거 + 한계(Proxy임) + confidence(0~1)
- 결과는 golden_review_queue에만 저장(queue_type=proxy_suggestion)

Acceptance Criteria:
- LLM이 “없는 SMILES를 창작”하지 않고, 후보 중 선택/평가만 수행
- 모든 LLM 결과는 review_queue에서 Admin 승인 전까지 DB 본문에 반영되지 않음

---

## 4) Quality Gate & 승격 로직
### 4.1 Gate 정의(Option C)
필수:
1) resolved_target_symbol 존재
2) (payload_smiles_standardized 존재) OR (proxy_smiles_flag=true)
3) evidence_refs >= 1

권장(가점):
- payload_features 존재
- evidence_refs >= 2
- clinical_nct_id_primary 존재(있으면 좋음)

### 4.2 quality_gate_job (신규)
- 모든 seed_item을 스캔하여 gate_status 산출:
  - PASS / NEEDS_REVIEW / BLOCKED
- 결과를 seed_item에 저장(예: gate_json)
- PASS 항목은 “승격 후보”로 UI에 표시

### 4.3 승격(Promote)
- Admin이 PASS 항목을 선택 → `golden_set_final`에 insert
- 승격 시 gate_snapshot 저장(감사/재현성 목적)

---

## 5) Admin UI 요구사항(간단하지만 운영 가능한 수준)
경로: `/admin/golden-sets`

### 5.1 탭 구조(권장: 기존 자동 수집 유지)
- Tab A: Auto (기존 golden_candidates 조회)
- Tab B: Manual (golden_seed_items + review queue + 승격)

### 5.2 Manual 탭 화면 구성
#### (1) Seed List
- 컬럼:
  - drug_name_canonical, target, resolved_target_symbol, payload_exact_name
  - smiles_status(SMILES/Proxy/None), evidence_count, gate_status(PASS/REVIEW/BLOCKED)
- 액션:
  - “상세보기”
  - “Enrich 실행”(단일 아이템)
  - “승격”(PASS만 활성)

#### (2) Seed Detail
- 섹션:
  - 기본정보(수정 가능)
  - Evidence refs 편집(수동 추가/삭제)
  - Verified 토글(필드별)
  - lineage 표시(어떤 job이 채웠는지)
- 버튼:
  - Run Resolver / Run PubChem / Run RDKit / Run All

#### (3) Review Queue (핵심)
- 리스트:
  - queue_type, seed_item, confidence, status, created_at
- Diff View:
  - 필드별 old(red) vs new(green)
  - evidence_refs 링크/표시
- 액션:
  - Approve(적용) / Reject / Edit then Apply
- 적용 규칙:
  - Apply 시 해당 필드만 업데이트 + verified 여부를 Admin이 선택(checkbox)

#### (4) Unmapped Queue
- 항목: unmapped_text, entity_type, context, status
- 액션:
  - “canonical 지정”(드롭다운/입력) → synonym_dictionary에 admin source로 저장 → status=resolved

---

## 6) 환경/운영(로컬 Docker 우선)
- 프론트(Next.js)가 백엔드(127.0.0.1:8000)에 붙는 구조라면,
  - Docker compose에서 backend 포트 노출 확인
  - Next.js proxy 설정에서 base_url을 ENV로 분리
    - 예: BACKEND_BASE_URL=http://127.0.0.1:8000 (local)
    - 배포 시 BACKEND_BASE_URL=https://api.xxx.com
- ECONNREFUSED 대응:
  - backend 컨테이너 상태/포트 바인딩/방화벽 확인
  - Next 서버 실행 환경과 backend 네트워크가 같은지 확인(docker network)

---

## 7) 구현 체크리스트(작업 단위)
### 7.1 DB 마이그레이션
- [ ] golden_seed_items 생성(+verified_json, lineage 포함)
- [ ] synonym_dictionary 생성(+unique index)
- [ ] unmapped_queue 생성
- [ ] golden_review_queue 생성(Diff 구조 전제)
- [ ] payload_features 생성(+is_proxy_derived, salt_removed)
- [ ] golden_set_final 생성

### 7.2 백엔드/워커
- [ ] resolve_ids_job 구현(사전 우선순위 + unmapped 적재)
- [ ] pubchem_enrich_job 구현(검색→표준화→review/protect)
- [ ] clinicaltrials_enrich_job 구현(옵션, hierarchy)
- [ ] rdkit_features_job 구현(salt remover 필수)
- [ ] quality_gate_job 구현(PASS/REVIEW/BLOCKED 산출)
- [ ] llm_proxy_suggest_job(선택) — review_queue only

### 7.3 Admin UI
- [ ] /admin/golden-sets 탭(Auto/Manual)
- [ ] Manual 리스트/상세/실행 버튼
- [ ] Review Queue Diff View(필수)
- [ ] Unmapped Queue 처리 UI(필수)
- [ ] 승격 UI(PASS만)

---

## 8) Acceptance Criteria (오늘 “완료” 정의)
- Manual Seed 20개가 리스트에 정상 노출
- resolve_ids_job로 20개 모두 resolved_target_symbol 확보(또는 unmapped 처리 가능)
- PubChem/RDKit로 20개에 대해:
  - SMILES 확보(12) + Proxy(8) 상태가 UI에 표시되고,
  - payload_features 계산이 생성되거나 review_queue로 오류가 남음
- Gate(Option C) 기준 PASS 항목이 자동 표시되고,
  - Admin이 클릭하여 golden_set_final로 승격 가능
- Verified 보호 로직이 동작하여:
  - Admin이 검증한 필드는 워커가 덮어쓰지 못하고 review_queue로만 제안됨
- Review Queue에서 Diff View로 승인/반려/수정 적용이 가능

---

## 9) 향후 확장(참고)
- Linker 기준값(대표 5~6종) + RDKit 유사도 기반 half-life 등급 추론
- “링커기술.pdf” 기반 규칙(절단 트리거, 안정성) → scoring_policies로 버전 관리
- Patent Chem-OCR은 Phase 2+ 장기 과제로 분리(초기엔 Manual Curation 유지)

---
끝.
