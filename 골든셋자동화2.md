# [추가 반영] Golden Set Seed-driven Enrichment — 품질/보호 강화 (v1.1 Addendum)

## A) [필수] Admin 확정 데이터 보호 (Overwrite Protection)

### A.1 스키마 (Seed 테이블)
**권장: 필드 단위 검증 플래그(정밀) + 전체 잠금 플래그(간편) 병행**

- is_manually_verified (BOOL, default false)  
  - true면: Job이 절대 자동으로 업데이트하지 않음(완전 잠금)

- field_verified JSONB (default '{}')  
  예시:
  {
    "clinical_nct_id": true,
    "payload_smiles": true,
    "resolved_target": true
  }

- last_verified_at (TIMESTAMP)
- verified_by (TEXT) (옵션)

### A.2 Job 공통 로직 규칙 (절대 덮어쓰기 금지)
Job 실행 시 각 Seed 레코드에 대해:

1) is_manually_verified == true 이면
- 자동 업데이트(SKIP)
- 대신 “변경이 필요해 보이는 사항”은 review_queue로만 등록 (정보 제공용)
- status는 'done' 또는 'skipped_verified'로 기록

2) is_manually_verified == false 이더라도, field_verified에서 해당 필드가 true면
- 해당 필드는 절대 overwrite 하지 않음
- 차이가 나면 review_queue로만 등록

### A.3 Review Queue 생성 규칙(“변경 제안” 모드)
- queue_type = overwrite_suggestion
- payload에 (current_value, suggested_value, reason, source) 포함
- Admin이 “적용” 버튼을 누를 때만 실제 업데이트


---

## B) [보완] ClinicalTrials “대표 임상(Representative NCT)” 선정 기준 구체화

### B.1 목표
단순 텍스트 매칭이 아니라, **해당 약물의 가장 진보된 상태를 대표하는 시험**을 찾는다.

### B.2 점수 모델 = Match Score + Hierarchy Score
최종 점수:
final_score = (match_score * 0.6) + (hierarchy_score * 0.4)

#### (1) match_score (기존 규칙 유지)
- drug_name/alias/target/ADC 키워드 기반

#### (2) hierarchy_score (신규)
- Phase 가점:
  - Phase 3: +1.0
  - Phase 2: +0.7
  - Phase 1: +0.4
  - Early Phase 1: +0.2
  - Not Provided: +0.0

- Status 가점:
  - ACTIVE_NOT_RECRUITING / RECRUITING: +0.6
  - COMPLETED: +0.5
  - TERMINATED / WITHDRAWN / SUSPENDED: +0.1 (단, 실패학습 목적이면 별도 저장)
  - UNKNOWN: +0.0

- “ADC 관련성” 가점(여전히 중요):
  - intervention/brief_title 등에 “antibody-drug conjugate / ADC / immunoconjugate” 포함: +0.3

### B.3 2트랙 저장(권장)
ADC 한 약물은 임상이 많으므로 “대표 1개”만 저장하면 손실이 큼:

- clinical_nct_id_primary: 대표 NCT (final_score 최고)
- clinical_nct_ids_secondary: 상위 N개(예: 3~5개) JSONB 저장

또는 별도 조인 테이블:
golden_seed_nct_links(seed_id, nct_id, score, is_primary, phase, status)

### B.4 실패/중단(Discontinued) 케이스 처리
- Terminated가 대표로 뽑히면 오탐 가능성이 높으므로:
  - (Late phase terminated) + (whyStopped 존재)면 “리스크 학습용 NCT”로는 저장하되,
  - primary 선정은 Active/Completed 우선으로 강제하는 규칙 추가 권장


---

## C) [보완] RDKit 전처리 — Salt Remover / Main Fragment 표준화

### C.1 이유
PubChem SMILES는 염/용매가 섞여 들어오는 경우가 많아 MW/LogP가 흔들림.

### C.2 처리 단계(필수)
RDKit 계산 직전:
1) SMILES → Mol 파싱
2) SaltRemover로 salt 제거
3) Fragment 중 “가장 큰 유기 fragment”를 main으로 선택
4) 표준화된 SMILES 재생성 → 이 값을 payload_features.smiles로 저장(원본은 별도 컬럼/RAW로 보존)

### C.3 저장 권장(추적성)
payload_features에 다음 컬럼 추가:
- smiles_raw (TEXT) : PubChem 원본 SMILES
- smiles_standardized (TEXT) : salt 제거/fragment 선택 후 SMILES (주 계산 대상)
- standardization_notes (TEXT or JSONB) : 제거된 salt 정보 등


---

## D) [수정] Job 의존성 명확화 — Target Resolution은 필수 선행

### D.1 실행 플로우 업데이트 (필수)
기존:
1) resolve_ids_job (optional)
→ 변경:
1) resolve_ids_job (REQUIRED)

### D.2 이유
- HER2가 ClinicalTrials에서는 ERBB2로 표기되는 케이스 존재
- FR alpha ↔ FOLR1, Tissue Factor ↔ F3 등 동의어/유전자명이 섞임

### D.3 Resolver 출력 최소 스펙
Seed의 target 입력을 다음으로 표준화:
- resolved_target_symbol: 예) ERBB2
- resolved_target_name: 예) HER2 (display)
- target_synonyms: JSONB

ClinicalTrials 검색 쿼리는 resolved_target_symbol을 반드시 포함하여 recall 확보


---

## E) [추가] Proxy 구조의 유사도/출처 표기 강화

### E.1 스키마 (payload_features)
- is_proxy_derived (BOOL, default false)  ✅ 강력 권장
- proxy_reference (TEXT) : 어떤 core/analog 기반인지
- proxy_similarity_score (FLOAT) : 가능하면(0~1), 초기엔 공란 허용
- proxy_method (TEXT) : manual | LLM_suggested | analog_from_pubchem 등

### E.2 표기 원칙(UI/보고서)
- is_proxy_derived == true이면:
  - “RDKit 지표는 Proxy 기반 추정치” 배지를 강제 표시
  - 보고서 요약/결론에서 proxy 항목은 confidence를 자동 감점하거나 별도 섹션으로 분리

(권장) confidence_score 구성에 proxy penalty 반영:
- proxy면 -10~-20점(정책 테이블에서 조절)


---

## F) 구현 체크리스트 (AntiGravity 수행 순서)
1) DB migration:
   - Seed 테이블: is_manually_verified, field_verified, last_verified_at 등 추가
   - payload_features: smiles_raw/smiles_standardized/is_proxy_derived 등 추가
   - review_queue: overwrite_suggestion type 추가
   - (선택) nct link 조인 테이블 추가

2) resolve_ids_job 필수화:
   - connector_executor에서 dependency 강제(없으면 실행 실패/선행 실행)

3) golden_enrich_clinical_job:
   - hierarchy_score 도입
   - primary + secondary 저장 구조 적용
   - verified protection 적용(덮어쓰기 금지)

4) golden_enrich_pubchem_job:
   - verified protection 적용
   - RAW 저장 철저

5) rdkit_features_job:
   - salt remover + main fragment 표준화
   - proxy flag 반영

6) Admin UI:
   - Review Queue에 overwrite_suggestion 표시/적용 버튼
   - NCT 확정 화면에 primary/secondary 후보 비교
   - SMILES 수기 입력 시 field_verified 자동 true 처리
